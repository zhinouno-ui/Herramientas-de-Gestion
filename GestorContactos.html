<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Gestor de Contactos â€“ RevinculaciÃ³n</title>
<style>
body{
  margin:0;
  font-family:Inter,system-ui,Arial;
  background:#0b0f1a;
  color:#e5e7eb;
}
header{
  padding:14px 20px;
  background:#020617;
  border-bottom:1px solid #1e293b;
  font-size:18px;
  font-weight:600;
}
main{
  display:grid;
  grid-template-columns:280px 1fr;
  height:calc(100vh - 56px);
}
aside{
  padding:16px;
  border-right:1px solid #1e293b;
}
section{
  padding:16px;
  overflow:auto;
}
.card{
  background:#020617;
  border:1px solid #1e293b;
  border-radius:10px;
  padding:12px;
  margin-bottom:12px;
}
button,input,select{
  background:#020617;
  color:#e5e7eb;
  border:1px solid #1e293b;
  border-radius:8px;
  padding:6px 10px;
}
button{
  cursor:pointer;
}
button:hover{background:#020617cc}
table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  padding:8px;
  border-bottom:1px solid #1e293b;
  text-align:left;
}
.actions{
  display:flex;
  gap:6px;
}
.actions button{
  width:32px;
  height:32px;
  padding:0;
}
.badge{
  padding:2px 8px;
  border-radius:999px;
  font-size:12px;
  background:#020617;
  border:1px solid #1e293b;
}
.tooltip{
  position:relative;
}
.tooltip:hover::after{
  content:attr(data-tip);
  position:absolute;
  bottom:110%;
  left:50%;
  transform:translateX(-50%);
  background:#020617;
  border:1px solid #1e293b;
  padding:4px 8px;
  font-size:11px;
  border-radius:6px;
  white-space:nowrap;
}
.modal{
  position:fixed;
  inset:0;
  background:#000a;
  display:none;
  align-items:center;
  justify-content:center;
}
.modal-content{
  background:#020617;
  border:1px solid #1e293b;
  border-radius:12px;
  padding:16px;
  width:420px;
}
.modal-content input{
  width:100%;
}
</style>
</head>
<body>

<header>ðŸ“‡ Gestor de Contactos â€“ RevinculaciÃ³n</header>

<main>
<aside>
  <div class="card">
    <input type="file" id="file">
    <input id="origin" placeholder="origen (google 1)">
    <button onclick="handleImport()">Importar VCF</button>
  </div>

  <div class="card">
    <button onclick="exportCSV()">Exportar CSV</button>
    <button onclick="resetAll()">ðŸ§¹ Limpiar todo</button>
  </div>
</aside>

<section>
<table>
<thead>
<tr>
<th>Nombre</th>
<th>TelÃ©fono</th>
<th>Origen</th>
<th>Estado</th>
<th>Acciones</th>
</tr>
</thead>
<tbody id="rows"></tbody>
</table>
</section>
</main>

<!-- MODAL DUPLICADOS -->
<div class="modal" id="dupModal">
<div class="modal-content">
<h3>Contacto duplicado</h3>
<p>ElegÃ­ o editÃ¡ el nombre final:</p>
<div>
<label>Existente</label>
<input id="oldName">
</div>
<div>
<label>Nuevo</label>
<input id="newName">
</div>
<div style="margin-top:10px;display:flex;gap:8px">
<button onclick="keepOld()">Usar existente</button>
<button onclick="keepNew()">Usar nuevo</button>
<button onclick="mergeNames()">Editar / unir</button>
</div>
</div>
</div>

<script>
let db;
let dupContext=null;

const req=indexedDB.open("contactosDB",1);
req.onupgradeneeded=e=>{
  db=e.target.result;
  db.createObjectStore("c",{keyPath:"phone"});
};
req.onsuccess=e=>{
  db=e.target.result;
  render();
};

function parseVCF(text){
  const contacts=[];
  const blocks=text.split("END:VCARD");
  blocks.forEach(b=>{
    const n=b.match(/FN:(.+)/);
    const t=b.match(/TEL[^:]*:(.+)/);
    if(t){
      contacts.push({
        name:n?n[1]:"",
        phone:t[1].replace(/\D/g,""),
        origin:origin.value||"default",
        status:"no_contactado"
      });
    }
  });
  return contacts;
}

function handleImport(){
  const f=file.files[0];
  if(!f)return;
  const r=new FileReader();
  r.onload=()=>{
    const parsed=parseVCF(r.result);
    parsed.forEach(c=>upsert(c));
  };
  r.readAsText(f);
}

function upsert(c){
  const tx=db.transaction("c","readwrite");
  const st=tx.objectStore("c");
  const g=st.get(c.phone);
  g.onsuccess=()=>{
    if(g.result){
      dupContext={old:g.result,new:c};
      oldName.value=g.result.name;
      newName.value=c.name;
      dupModal.style.display="flex";
    }else{
      st.put(c);
      render();
    }
  };
}

function keepOld(){
  dupModal.style.display="none";
}
function keepNew(){
  const tx=db.transaction("c","readwrite");
  tx.objectStore("c").put(dupContext.new);
  dupModal.style.display="none";
  render();
}
function mergeNames(){
  dupContext.old.name=oldName.value;
  const tx=db.transaction("c","readwrite");
  tx.objectStore("c").put(dupContext.old);
  dupModal.style.display="none";
  render();
}

function setStatus(p,s){
  const tx=db.transaction("c","readwrite");
  const st=tx.objectStore("c");
  st.get(p).onsuccess=e=>{
    const c=e.target.result;
    c.status=s;
    st.put(c);
    render();
  };
}

function delContact(p){
  const tx=db.transaction("c","readwrite");
  tx.objectStore("c").delete(p);
  render();
}

function resetAll(){
  if(!confirm("Borrar TODO?"))return;
  indexedDB.deleteDatabase("contactosDB");
  location.reload();
}

function render(){
  const tb=document.getElementById("rows");
  tb.innerHTML="";
  const tx=db.transaction("c","readonly");
  tx.objectStore("c").openCursor().onsuccess=e=>{
    const cur=e.target.result;
    if(!cur)return;
    const c=cur.value;
    tb.innerHTML+=`
<tr>
<td contenteditable onblur="cEdit('${c.phone}',this.innerText)">${c.name}</td>
<td>${c.phone}</td>
<td><span class="badge">${c.origin}</span></td>
<td><span class="badge">${c.status}</span></td>
<td class="actions">
<button class="tooltip" data-tip="Interesado" onclick="setStatus('${c.phone}','interesado')">âœ”</button>
<button class="tooltip" data-tip="Desinteresado" onclick="setStatus('${c.phone}','desinteresado')">âœ–</button>
<button class="tooltip" data-tip="Sin WhatsApp" onclick="setStatus('${c.phone}','sin_whatsapp')">ðŸš«</button>
<button class="tooltip" data-tip="Eliminar" onclick="delContact('${c.phone}')">ðŸ—‘</button>
</td>
</tr>`;
    cur.continue();
  };
}

function cEdit(p,n){
  const tx=db.transaction("c","readwrite");
  const st=tx.objectStore("c");
  st.get(p).onsuccess=e=>{
    const c=e.target.result;
    c.name=n;
    st.put(c);
  };
}

function exportCSV(){
  const rows=[["Nombre","Telefono","Origen","Estado"]];
  const tx=db.transaction("c","readonly");
  tx.objectStore("c").openCursor().onsuccess=e=>{
    const cur=e.target.result;
    if(cur){
      const c=cur.value;
      rows.push([c.name,c.phone,c.origin,c.status]);
      cur.continue();
    }else{
      const csv=rows.map(r=>r.join(",")).join("\n");
      const a=document.createElement("a");
      a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
      a.download="contactos.csv";
      a.click();
    }
  };
}
</script>

</body>
</html>
