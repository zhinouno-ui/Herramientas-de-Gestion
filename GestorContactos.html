<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Gestor de Contactos â€“ RevinculaciÃ³n</title>
  <style>
    :root{
      --bg:#0f172a;--panel:#111827;--card:#020617;
      --text:#e5e7eb;--muted:#9ca3af;--accent:#22c55e;--warn:#f59e0b;--danger:#ef4444;--info:#38bdf8;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto}
    body{margin:0;background:#020617;color:var(--text)}
    header{padding:16px 20px;border-bottom:1px solid #1f2937;display:flex;gap:16px;align-items:center}
    header h1{font-size:18px;margin:0;font-weight:600}
    .wrap{display:grid;grid-template-columns:280px 1fr;min-height:calc(100vh - 60px)}
    aside{border-right:1px solid #1f2937;padding:16px;display:flex;flex-direction:column;gap:12px}
    main{padding:16px}
    .card{background:rgba(2,6,23,.8);border:1px solid #1f2937;border-radius:14px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .card h3{margin:0 0 8px 0;font-size:14px;color:#cbd5f5}
    .btn{background:#020617;border:1px solid #1f2937;color:var(--text);padding:6px 8px;border-radius:10px;cursor:pointer;font-size:12px}
    .btn:hover{border-color:#334155}
    .btn.accent{background:rgba(34,197,94,.1);border-color:rgba(34,197,94,.4)}
    .btn.warn{background:rgba(245,158,11,.1);border-color:rgba(245,158,11,.4)}
    .btn.danger{background:rgba(239,68,68,.1);border-color:rgba(239,68,68,.4)}
    .btn.info{background:rgba(56,189,248,.1);border-color:rgba(56,189,248,.4)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input,select{background:#020617;border:1px solid #1f2937;color:var(--text);padding:8px 10px;border-radius:10px}
    input::placeholder{color:#64748b}
    .stats{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
    .stat{background:#020617;border:1px solid #1f2937;border-radius:12px;padding:10px}
    .stat b{font-size:18px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #1f2937;font-size:13px}
    th{color:#cbd5f5;text-align:left}
    tr:hover{background:#020617}
    .tag{padding:2px 8px;border-radius:999px;border:1px solid #1f2937;font-size:11px}
    .t-ok{border-color:rgba(34,197,94,.6);color:#86efac}
    .t-warn{border-color:rgba(245,158,11,.6);color:#fde68a}
    .t-no{border-color:rgba(239,68,68,.6);color:#fca5a5}
    .t-info{border-color:rgba(56,189,248,.6);color:#7dd3fc}
    .actions{display:flex;gap:4px;flex-wrap:wrap}
    footer{padding:10px;color:#64748b;font-size:12px}

    .modal-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.65);
      display:flex;align-items:center;justify-content:center;z-index:1000;
    }
    .modal{
      background:#020617;border:1px solid #1f2937;
      border-radius:16px;padding:18px;max-width:420px;width:100%;
    }
    .modal h2{margin:0 0 10px 0;font-size:16px;color:#cbd5f5}
    .modal small{color:#94a3b8}
    .modal input{width:100%;margin-top:6px;margin-bottom:6px}
    .modal .row{justify-content:flex-end}
  </style>
</head>

<body>
<header>
  <h1>ðŸ“‡ Gestor de Contactos â€“ RevinculaciÃ³n</h1>
  <span style="color:#64748b;font-size:12px">Persistencia local (IndexedDB) Â· Import CSV / VCF Â· DetecciÃ³n de duplicados</span>
</header>

<div class="wrap">
  <aside>
    <div class="card">
      <h3>Importar CSV / VCF</h3>
      <input type="file" id="csvFile" accept=".csv,.vcf" />
      <input id="csvOrigen" placeholder="Origen (ej: google1)" />
      <button class="btn accent" onclick="importCSV()">Importar / Actualizar</button>
      <p style="font-size:12px;color:#94a3b8">Si el archivo ya fue importado, solo agrega contactos nuevos (por telÃ©fono).</p>
    </div>

    <div class="card">
      <h3>Filtros</h3>
      <input id="search" placeholder="Buscar nombre o telÃ©fono" oninput="render()" />
      <select id="fEstado" onchange="render()">
        <option value="">Todos los estados</option>
        <option value="no_contactado">No contactado</option>
        <option value="contactado">Contactado</option>
        <option value="interesado">Interesado</option>
        <option value="desinteresado">Desinteresado</option>
        <option value="sin_whatsapp">Sin WhatsApp</option>
      </select>
      <input id="fOrigen" placeholder="Filtrar por origen" oninput="render()" />
    </div>

    <div class="card">
      <h3>EstadÃ­sticas</h3>
      <div class="stats">
        <div class="stat"><b id="stTotal">0</b><div>Total</div></div>
        <div class="stat"><b id="stInter">0</b><div>Interesados</div></div>
        <div class="stat"><b id="stDes">0</b><div>Desinteresados</div></div>
        <div class="stat"><b id="stNo">0</b><div>No contactados</div></div>
      </div>
    </div>

    <div class="card">
      <h3>Exportar</h3>
      <button class="btn info" onclick="exportCSV()">Exportar todo (CSV)</button>
    </div>

    <div class="card">
      <h3>Mantenimiento</h3>
      <button class="btn danger" onclick="vaciarDB()">Vaciar contactos</button>
      <p style="font-size:12px;color:#94a3b8">
        Elimina todos los contactos guardados en este navegador.
      </p>
    </div>
  </aside>

  <main>
    <div class="card">
      <h3>Contactos</h3>
      <table>
        <thead>
          <tr><th>Nombre</th><th>TelÃ©fono</th><th>Origen</th><th>Estado</th><th>Acciones</th></tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </main>
</div>

<footer>Datos guardados localmente en el navegador (IndexedDB).</footer>

<script>
/* =================== IndexedDB =================== */
let db;
const req = indexedDB.open('contactosDB',1);
req.onupgradeneeded = e => {
  db = e.target.result;
  db.createObjectStore('contactos',{keyPath:'telefono'});
};
req.onsuccess = e => { db = e.target.result; render(); };

function getAll(cb){
  const tx=db.transaction('contactos','readonly');
  tx.objectStore('contactos').getAll().onsuccess=e=>cb(e.target.result||[]);
}
function put(c){
  const tx=db.transaction('contactos','readwrite');
  tx.objectStore('contactos').put(c);
}
function del(t){
  const tx=db.transaction('contactos','readwrite');
  tx.objectStore('contactos').delete(t);
}

/* =================== IMPORTACIÃ“N =================== */
let dupQueue=[];

/* --- IMPORTAR DESDE ARCHIVO --- */
function importCSV(){
  const file=document.getElementById('csvFile').files[0];
  const origen=document.getElementById('csvOrigen').value.trim()||'sin_origen';
  if(!file){ alert('SeleccionÃ¡ un archivo'); return; }

  const r=new FileReader();
  r.onload=()=>{
    const text=r.result;

    if(file.name.toLowerCase().endsWith('.vcf') || text.includes('BEGIN:VCARD')){
      importVCF(text,origen);
      return;
    }

    // CSV simple: nombre,telefono,...
    const lines=text.split(/\r?\n/).filter(l=>l.trim());
    lines.forEach((l,i)=>{
      const parts=l.split(',');
      if(parts.length<2) return;
      let nombre=parts[0].trim();
      let telefono=(parts[1]||'').replace(/[^0-9]/g,'');
      if(!telefono) return;

      const tx=db.transaction('contactos','readwrite');
      const store=tx.objectStore('contactos');
      const req=store.get(telefono);

      req.onsuccess=()=>{
        const ex=req.result;
        if(!ex){
          store.put({telefono,nombre,origen,estado:'no_contactado',fecha:''});
          return;
        }

        const oldName=(ex.nombre||'').trim();
        const sameName=!nombre || oldName.toLowerCase()===nombre.toLowerCase();

        const origs=(ex.origen||'').split(',').map(o=>o.trim());
        const sameOrigin=origs.includes(origen);

        if(sameName || sameOrigin){
          if(!sameOrigin) ex.origen += ','+origen;
          if(!oldName && nombre) ex.nombre=nombre;
          store.put(ex);
          return;
        }

        dupQueue.push({telefono,origen,existente:ex,nuevo:{telefono,nombre,origen}});
      };
    });

    setTimeout(()=>processNextDuplicate(),300);
    setTimeout(render,600);
  };
  r.readAsText(file);
}

/* --- IMPORTAR VCF --- */
function importVCF(text,origen){
  dupQueue=[];
  const cards=text.split('BEGIN:VCARD').slice(1);

  cards.forEach(card=>{
    const telMatch=card.match(/TEL[^:]*:(.+)/i);
    if(!telMatch) return;

    const telefono=telMatch[1].replace(/[^0-9]/g,'');
    const nameMatch=card.match(/FN:(.+)/i);
    const nombre=(nameMatch?nameMatch[1]:'').trim();

    const tx=db.transaction('contactos','readwrite');
    const store=tx.objectStore('contactos');
    const req=store.get(telefono);

    req.onsuccess=()=>{
      const ex=req.result;

      if(!ex){
        store.put({telefono,nombre,origen,estado:'no_contactado',fecha:''});
        return;
      }

      const oldName=(ex.nombre||'').trim();
      const newName=nombre;
      const sameName=!newName || oldName.toLowerCase()===newName.toLowerCase();

      const origs=(ex.origen||'').split(',').map(o=>o.trim());
      const sameOrigin=origs.includes(origen);

      if(sameName || sameOrigin){
        if(!sameOrigin) ex.origen += ','+origen;
        if(!oldName && newName) ex.nombre=newName;
        store.put(ex);
        return;
      }

      dupQueue.push({telefono,origen,existente:ex,nuevo:{telefono,nombre,origen}});
    };
  });

  setTimeout(()=>processNextDuplicate(),400);
  setTimeout(render,800);
}

/* =================== MODAL DUPLICADOS =================== */
function processNextDuplicate(){
  if(!dupQueue.length) return;
  const item=dupQueue.shift();
  showDuplicateModal(item,()=>processNextDuplicate());
}

function showDuplicateModal(item,done){
  const {telefono,existente,nuevo,origen}=item;

  const back=document.createElement('div');
  back.className='modal-backdrop';

  const box=document.createElement('div');
  box.className='modal';
  box.innerHTML=`
    <h2>Contacto duplicado</h2>
    <small>TelÃ©fono: ${telefono}</small>

    <div style="margin-top:10px">
      <div>Nombre existente</div>
      <input id="oldName" value="${existente.nombre||''}">
    </div>

    <div>
      <div>Nuevo nombre detectado</div>
      <input id="newName" value="${nuevo.nombre||''}">
    </div>

    <div class="row">
      <button class="btn" id="keepOld">Conservar existente</button>
      <button class="btn accent" id="useNew">Usar nuevo</button>
    </div>
  `;

  back.appendChild(box);
  document.body.appendChild(back);

  function ensureOrigin(obj){
    obj.origen=(obj.origen||'').trim();
    if(!obj.origen) obj.origen=origen;
    else if(!obj.origen.split(',').map(o=>o.trim()).includes(origen))
      obj.origen+=','+origen;
  }

  box.querySelector('#keepOld').onclick=()=>{
    ensureOrigin(existente);
    put(existente);
    document.body.removeChild(back);
    done();
  };

  box.querySelector('#useNew').onclick=()=>{
    existente.nombre=box.querySelector('#newName').value.trim();
    ensureOrigin(existente);
    put(existente);
    document.body.removeChild(back);
    done();
  };
}

/* =================== RENDER =================== */
function render(){
  if(!db) return;
  const q=document.getElementById('search').value.toLowerCase();
  const fe=document.getElementById('fEstado').value;
  const fo=document.getElementById('fOrigen').value.toLowerCase();

  getAll(all=>{
    let arr=all.filter(c=>
      (!q|| (c.nombre||'').toLowerCase().includes(q)||c.telefono.includes(q)) &&
      (!fe||c.estado===fe) &&
      (!fo|| (c.origen||'').toLowerCase().includes(fo))
    );

    const tb=document.getElementById('tbody');
    tb.innerHTML='';

    arr.forEach(c=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td contenteditable onblur="editName('${c.telefono}',this.innerText)">${c.nombre||''}</td>
        <td>${c.telefono}</td>
        <td><span class="tag t-info">${c.origen||''}</span></td>
        <td><span class="tag">${c.estado}</span></td>
        <td class="actions">
          <button class="btn accent" onclick="setEstado('${c.telefono}','interesado')">âœ”</button>
          <button class="btn warn" onclick="setEstado('${c.telefono}','contactado')">â˜Ž</button>
          <button class="btn danger" onclick="setEstado('${c.telefono}','desinteresado')">âœ–</button>
          <button class="btn" onclick="setEstado('${c.telefono}','sin_whatsapp')">ðŸš«</button>
          <button class="btn info" onclick="wa('${c.telefono}')">WA</button>
          <button class="btn danger" onclick="deleteContacto('${c.telefono}')">ðŸ—‘</button>
        </td>`;
      tb.appendChild(tr);
    });

    stats(all);
  });
}

function setEstado(t,e){
  getAll(all=>{
    const c=all.find(x=>x.telefono===t);
    if(!c) return;
    c.estado=e;
    c.fecha=new Date().toISOString();
    put(c);
    render();
  });
}

function editName(t,n){
  getAll(all=>{
    const c=all.find(x=>x.telefono===t);
    if(!c) return;
    c.nombre=n.trim();
    put(c);
  });
}

function deleteContacto(t){
  if(confirm('Â¿Eliminar este contacto?')){ del(t); render(); }
}

function wa(t){ window.open('https://wa.me/'+t,'_blank'); }

function stats(all){
  document.getElementById('stTotal').innerText=all.length;
  document.getElementById('stInter').innerText=all.filter(c=>c.estado==='interesado').length;
  document.getElementById('stDes').innerText=all.filter(c=>c.estado==='desinteresado').length;
  document.getElementById('stNo').innerText=all.filter(c=>c.estado==='no_contactado').length;
}

/* =================== VACIAR =================== */
function vaciarDB(){
  if(!confirm('Â¿Seguro que querÃ©s borrar TODOS los contactos?')) return;
  const tx=db.transaction('contactos','readwrite');
  const store=tx.objectStore('contactos');
  store.clear().onsuccess=()=>{
    alert('Contactos eliminados');
    render();
  };
}

/* =================== EXPORT =================== */
function exportCSV(){
  getAll(all=>{
    let csv='nombre,telefono,origen,estado,fecha\n';
    all.forEach(c=>csv+=`${c.nombre||''},${c.telefono},${c.origen||''},${c.estado||''},${c.fecha||''}\n`);
    const a=document.createElement('a');
    a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
    a.download='contactos_export.csv';
    a.click();
  });
}
</script>
</body>
</html>
