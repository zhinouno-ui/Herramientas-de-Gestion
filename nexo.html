<!DOCTYPE html>
<!-- saved from url=(0038)https://toolboard.vercel.app/nexo.html -->
<html lang="es"><script src="chrome-extension://eppiocemhmnlbhjplcgkofciiegomcon/content/location/location.js" id="eppiocemhmnlbhjplcgkofciiegomcon"></script><script src="chrome-extension://eppiocemhmnlbhjplcgkofciiegomcon/libs/extend-native-history-api.js"></script><script src="chrome-extension://eppiocemhmnlbhjplcgkofciiegomcon/libs/requests.js"></script><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Contactos Masivo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #334155;
            --accent-primary: #3b82f6;
            --accent-success: #10b981;
            --accent-warning: #f59e0b;
            --accent-danger: #ef4444;
            --accent-neutral: #6b7280;
            --accent-jugando: #8b5cf6;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --border-color: #475569;
            --hover-color: #475569;
            --selection-bg: rgba(59, 130, 246, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }


        /* Pantalla de inicio */
        .upload-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: linear-gradient(135deg, var(--bg-primary) 0%, #1e1b4b 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s ease, transform 0.5s ease;
        }

        .upload-screen.hidden {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
        }

        .upload-card {
            background: var(--bg-secondary);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            max-width: 500px;
            width: 90%;
            text-align: center;
            border: 2px solid var(--accent-primary);
        }

        .upload-card h1 {
            margin-bottom: 30px;
            font-size: 2.2rem;
            background: linear-gradient(90deg, var(--accent-primary), #8b5cf6);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .upload-card i {
            font-size: 4rem;
            color: var(--accent-primary);
            margin-bottom: 20px;
        }

        .file-upload-area {
            border: 3px dashed var(--border-color);
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload-area:hover {
            border-color: var(--accent-primary);
            background: rgba(59, 130, 246, 0.05);
        }

        .origin-input {
            width: 100%;
            padding: 12px 15px;
            margin-top: 20px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 1rem;
        }
        
        .file-list {
            margin-top: 20px;
            max-height: 150px;
            overflow-y: auto;
            text-align: left;
        }
        .file-item {
            background: var(--bg-card);
            padding: 10px 15px;
            margin: 5px 0;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }
        .file-item span:last-child {
            color: var(--text-secondary);
        }

        .btn-primary {
            background: linear-gradient(90deg, var(--accent-primary), #6366f1);
            color: white;
            border: none;
            padding: 14px 30px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 20px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
        }
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Barra de navegación */
        .navbar {
            background: linear-gradient(180deg, rgba(30, 41, 59, 0.96), rgba(30, 41, 59, 0.88));
            padding: 15px 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(148, 163, 184, 0.14);
        }

        .stats { display: flex; gap: 10px; flex-wrap: wrap; flex: 1; }
        .stat-box { background: var(--bg-card); padding: 10px 15px; border-radius: 10px; min-width: 120px; text-align: center; cursor: pointer; transition: all 0.3s; border: 2px solid transparent; }
        .stat-box:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); }
        .stat-box.active { border-color: var(--accent-primary); }
        .stat-value { font-size: 1.3rem; font-weight: 700; }
        .stat-total .stat-value { color: var(--accent-primary); }
        .stat-unreviewed .stat-value { color: #9ca3af; }
        .stat-contactado .stat-value { color: var(--accent-success); }
        .stat-jugando .stat-value { color: var(--accent-jugando); }
        .stat-sin-wsp .stat-value { color: var(--accent-warning); }
        .stat-no-interesado .stat-value { color: var(--accent-danger); }
        .stat-duplicados .stat-value { color: var(--accent-warning); }
        .stat-label { font-size: 0.75rem; color: var(--text-secondary); margin-top: 3px; }

        .view-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            background: var(--bg-card);
            color: var(--text-primary);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn:hover { background: var(--hover-color); transform: translateY(-2px); }
        .btn.active { background: var(--accent-primary); color: white; }
        .btn i { font-size: 1rem; }
        .btn-danger { background: var(--accent-danger); color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-success { background: var(--accent-success); color: white; }
        .btn-success:hover { background: #059669; }
        .btn-warning { background: var(--accent-warning); color: white; }
        .btn-warning:hover { background: #d97706; }

        /* Barra de búsqueda */
        .search-bar {
            background: linear-gradient(180deg, rgba(30, 41, 59, 0.96), rgba(30, 41, 59, 0.88));
            padding: 15px 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(148, 163, 184, 0.14);
        }
        .search-input {
            flex: 1;
            min-width: 250px;
            padding: 10px 15px;
            padding-left: 40px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.95rem;
            position: relative;
        }
        .search-input:focus { border-color: var(--accent-primary); outline: none; }
        .search-icon { position: absolute; left: 35px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); pointer-events: none; }

        .filter-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 10px 15px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.9rem;
            cursor: pointer;
            min-width: 150px;
        }
        .filter-select:focus { border-color: var(--accent-primary); outline: none; }

        /* Barra de acciones masivas */
        .bulk-actions-bar {
            background: linear-gradient(90deg, var(--accent-primary), #6366f1);
            padding: 15px 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            display: none;
            align-items: center;
            gap: 15px;
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
        }
        .bulk-actions-bar.active { display: flex; }
        .bulk-count { font-weight: 700; font-size: 1.1rem; }
        .bulk-actions { display: flex; gap: 10px; margin-left: auto; flex-wrap: wrap; }

        /* Vista de tarjetas */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .contact-card {
            --status-rgb: 148,163,184;
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            position: relative;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
        }
        .contact-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            border-color: var(--accent-primary);
        }
        .contact-card.selected { border-color: var(--accent-primary); background: var(--selection-bg); }
        .contact-card::after {
            content: '';
            position: absolute;
            right: -28px;
            top: 50%;
            transform: translateY(-50%);
            width: 130px;
            height: 130px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(var(--status-rgb),0.18) 0%, transparent 70%);
            pointer-events: none;
        }
        .contact-card.duplicate { border-color: var(--accent-warning); }
        .duplicate-badge {
            position: absolute;
            top: 10px;
            right: 50px;
            background: var(--accent-warning);
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.7rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.4);
        }

        .card-checkbox {
            position: absolute;
            top: 15px;
            left: 15px;
            width: 24px;
            height: 24px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .contact-card:hover .card-checkbox,
        .contact-card.selected .card-checkbox {
            opacity: 1;
        }

        .contact-card.selected::before {
            content: '✓';
            position: absolute;
            top: 15px;
            left: 15px;
            width: 24px;
            height: 24px;
            background: var(--accent-primary);
            color: white;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1rem;
            z-index: 1;
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
            margin-top: 10px;
        }
        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: var(--bg-card);
        }
        .card-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            word-break: break-word;
            flex: 1;
        }

        .card-details {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }
        .detail-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        .detail-item i { width: 20px; text-align: center; color: var(--accent-primary); }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-sin-revisar { background: #374151; color: #9ca3af; }
        .status-contactado { background: rgba(16, 185, 129, 0.2); color: var(--accent-success); }
        .status-jugando { background: rgba(139, 92, 246, 0.2); color: var(--accent-jugando); }
        .status-sin-wsp { background: rgba(245, 158, 11, 0.2); color: var(--accent-warning); }
        .status-no-interesado { background: rgba(239, 68, 68, 0.2); color: var(--accent-danger); }
        .card-status-inline { min-width: 150px; display: inline-block; }
        .card-status-select {
            width: 100%;
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 6px 10px;
            font-size: 0.8rem;
        }

        .card-footer {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
            font-size: 0.75rem;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
        }

        /* Vista de lista mejorada */
        .list-view {
            background: var(--bg-secondary);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(148, 163, 184, 0.14);
        }
        
        .list-header {
            background: var(--bg-card);
            padding: 15px 20px;
            display: grid;
            grid-template-columns: 50px 2fr 1.5fr 1.2fr 1fr 80px 380px;
            gap: 15px;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            color: var(--text-secondary);
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .list-item {
            position: relative;
            overflow: hidden;
            padding: 15px 20px;
            display: grid;
            grid-template-columns: 50px 2fr 1.5fr 1.2fr 1fr 80px 380px;
            gap: 15px;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.2s;
        }

        .list-item-main {
            position: relative;
            overflow: hidden;
            border-radius: 12px;
            padding: 10px 12px;
            background: rgba(15, 23, 42, 0.18);
        }

        .list-item-main::before {
            content: '';
            position: absolute;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            right: -18px;
            top: 50%;
            transform: translateY(-50%);
            background: radial-gradient(circle, rgba(var(--status-rgb, 148,163,184), 0.32) 0%, transparent 70%);
            pointer-events: none;
        }

        .list-status-bg-icon {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 2.1rem;
            color: var(--status-color, #94a3b8);
            opacity: 0.18;
            filter: blur(0.3px);
            pointer-events: none;
        }

        .list-name-row {
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1;
        }

        .list-status-chip {
            margin-top: 6px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 3px 10px;
            border-radius: 999px;
            font-size: 0.72rem;
            color: var(--status-color, var(--text-secondary));
            background: rgba(var(--status-rgb, 148,163,184), 0.18);
            text-transform: uppercase;
            letter-spacing: 0.03em;
            font-weight: 600;
        }
        
        .list-item:hover { background: var(--hover-color); }
        .list-item.selected { 
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.15), rgba(59, 130, 246, 0.05));
            border-left: 4px solid var(--accent-primary);
        }
        .list-item.duplicate { 
            background: rgba(245, 158, 11, 0.08); 
            border-right: 4px solid var(--accent-warning); 
        }
        .list-item.duplicate.selected {
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.15), rgba(245, 158, 11, 0.08));
            border-left: 4px solid var(--accent-primary);
            border-right: 4px solid var(--accent-warning);
        }
        .list-item:last-child { border-bottom: none; }

        .list-item::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, rgba(var(--status-rgb,148,163,184),0.13), transparent 35%);
            opacity: 0.5;
            pointer-events: none;
        }

        .list-item::after {
            content: '';
            position: absolute;
            width: 180px;
            height: 180px;
            right: -55px;
            top: 50%;
            transform: translateY(-50%);
            border-radius: 50%;
            background: radial-gradient(circle, rgba(var(--status-rgb,148,163,184),0.16) 0%, transparent 70%);
            pointer-events: none;
        }
        
        .list-item-name {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .list-item-phone {
            color: var(--text-secondary);
            font-family: monospace;
        }
        
        .list-item-origin {
            color: var(--text-secondary);
        }
        
        .list-item-date {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        
        .list-item-actions {
            display: flex;
            gap: 5px;
            justify-content: flex-end;
        }
        
        .list-item-actions .btn {
            padding: 6px 12px;
            font-size: 0.8rem;
        }

        .whatsapp-cell {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .whatsapp-btn {
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #25D366;
            color: white;
        }
        .whatsapp-btn:hover {
            background: #128C7E;
        }
        .whatsapp-btn i {
            font-size: 1.2rem;
        }

        .status-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            justify-content: flex-start;
        }

        .status-btn {
            padding: 0;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--bg-card);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .status-btn i {
            font-size: 1rem;
        }


        .status-btn:hover {
            transform: translateY(-2px);
        }

        .status-btn.active {
            border-color: currentColor;
        }

        .status-btn.sin-revisar { color: #9ca3af; }
        .status-btn.sin-revisar.active { background: #374151; color: #9ca3af; }
        
        .status-btn.contactado { color: var(--accent-success); }
        .status-btn.contactado.active { background: rgba(16, 185, 129, 0.2); color: var(--accent-success); }
        
        .status-btn.jugando { color: var(--accent-jugando); }
        .status-btn.jugando.active { background: rgba(139, 92, 246, 0.2); color: var(--accent-jugando); }
        
        .status-btn.sin-wsp { color: var(--accent-warning); }
        .status-btn.sin-wsp.active { background: rgba(245, 158, 11, 0.2); color: var(--accent-warning); }
        
        .status-btn.no-interesado { color: var(--accent-danger); }
        .status-btn.no-interesado.active { background: rgba(239, 68, 68, 0.2); color: var(--accent-danger); }

        /* Barra de progreso */
        .progress-bar-container {
            background: var(--bg-secondary);
            padding: 15px 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(148, 163, 184, 0.14);
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .progress-title {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .progress-percentage {
            color: var(--accent-primary);
            font-size: 1.5rem;
            font-weight: 700;
        }

        .progress-details {
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin-top: 5px;
            text-align: right;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-card);
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-success));
            transition: width 0.3s ease;
        }

        /* Paginación */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 25px;
            flex-wrap: wrap;
        }
        .pagination button {
            background: var(--bg-card);
            color: var(--text-primary);
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        .pagination button:hover:not(:disabled) { background: var(--hover-color); transform: translateY(-2px); }
        .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
        .pagination button.active { background: var(--accent-primary); color: white; }
        .pagination .page-info { color: var(--text-secondary); font-size: 0.9rem; }

        /* Modal de exportación */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: var(--bg-secondary);
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        .modal-header {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text-primary);
        }
        .export-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 20px 0;
        }
        .export-option {
            background: var(--bg-card);
            padding: 15px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .export-option:hover { border-color: var(--accent-primary); transform: translateY(-2px); }
        .export-option.selected { border-color: var(--accent-primary); background: var(--selection-bg); }
        .export-option i { font-size: 1.5rem; color: var(--accent-primary); }
        .export-option-text { flex: 1; }
        .export-option-title { font-weight: 600; font-size: 1rem; margin-bottom: 3px; }
        .export-option-desc { font-size: 0.85rem; color: var(--text-secondary); }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }
        .modal-actions .btn { flex: 1; justify-content: center; }

        /* Notificaciones */
        .notification {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 3000;
            animation: slideIn 0.3s ease;
            max-width: 400px;
        }
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .notification.success { border-left: 4px solid var(--accent-success); }
        .notification.error { border-left: 4px solid var(--accent-danger); }
        .notification.info { border-left: 4px solid var(--accent-primary); }
        .notification i { font-size: 1.5rem; }
        .notification.success i { color: var(--accent-success); }
        .notification.error i { color: var(--accent-danger); }
        .notification.info i { color: var(--accent-primary); }

        /* Historial */
        .history-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .history-item {
            background: var(--bg-card);
            padding: 12px 15px;
            margin: 8px 0;
            border-radius: 8px;
            font-size: 0.9rem;
            border-left: 3px solid var(--accent-primary);
        }
        .history-time {
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin-bottom: 5px;
        }
        .history-action {
            color: var(--text-primary);
        }

        /* Duplicados */
        .duplicates-list {
            max-height: 500px;
            overflow-y: auto;
            margin: 20px 0;
        }
        .duplicate-group {
            background: var(--bg-card);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid var(--accent-warning);
        }
        .duplicate-group-header {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--accent-warning);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .duplicate-item {
            background: var(--bg-secondary);
            padding: 10px;
            margin: 5px 0;
            border-radius: 8px;
            font-size: 0.9rem;
        }
        .duplicate-item-detail {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-left: 10px;
        }


        .whatsapp-template {
            margin-top: 15px;
            background: var(--bg-card);
            border-radius: 12px;
            padding: 12px;
            border: 1px solid rgba(148, 163, 184, 0.2);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .whatsapp-template textarea {
            width: 100%;
            min-height: 88px;
            resize: vertical;
            background: #0f172a;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 8px;
            padding: 10px;
        }
        .template-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .template-help { color: var(--text-secondary); font-size: 0.82rem; }

        .timeline-view {
            background: var(--bg-secondary);
            border-radius: 15px;
            border: 1px solid rgba(148, 163, 184, 0.14);
            padding: 16px;
            display: none;
        }
        .timeline-day { margin-bottom: 16px; }
        .timeline-day-title { font-weight: 700; color: var(--accent-primary); margin-bottom: 8px; }
        .timeline-event {
            background: var(--bg-card);
            border-left: 3px solid var(--accent-primary);
            border-radius: 8px;
            padding: 10px;
            margin: 6px 0;
            font-size: 0.88rem;
            color: var(--text-secondary);
        }
        .timeline-event strong { color: var(--text-primary); }

        .duplicates-config {
            margin: 12px 0;
            padding: 10px;
            border-radius: 8px;
            background: rgba(30,41,59,0.65);
            border: 1px solid rgba(148,163,184,0.2);
            font-size: 0.85rem;
            color: var(--text-secondary);
            display: flex;
            gap: 8px;
            flex-direction: column;
        }
        .shortcut-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }
        .shortcut-item {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 8px 10px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        .shortcut-item kbd {
            background: #0f172a;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 2px 6px;
            color: var(--text-primary);
        }
        @media (max-width: 768px) {
            .navbar, .search-bar { flex-direction: column; align-items: stretch; }
            .stats { justify-content: center; }
            .list-header { display: none; }
            .list-item {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            .list-item-main {
                width: 100%;
            }
            .cards-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body __processed_06e8811e-2870-46d5-8df7-cb489419a036__="true">
    <div class="upload-screen" id="uploadScreen">
        <div class="upload-card">
            <i class="fas fa-cloud-upload-alt"></i>
            <h1>Gestor de Contactos Masivo</h1>
            <p style="color: var(--text-secondary); margin-bottom: 20px;">Importa tus contactos desde archivos CSV</p>
            <div class="file-upload-area" id="uploadArea">
                <i class="fas fa-file-csv" style="font-size: 3rem; color: var(--accent-primary);"></i>
                <p style="margin-top: 15px; color: var(--text-secondary);">Arrastra archivos CSV o VCF aquí o haz clic para seleccionar</p>
                <input type="file" id="fileInput" accept=".csv,.vcf" multiple="" style="display: none;">
            </div>
            <div class="file-list" id="fileList"></div>
            <input type="text" id="originInput" class="origin-input" placeholder="Origen de los contactos (ej: Turno Mañana, Facebook, etc.)">
            <button id="startBtn" class="btn-primary" disabled>Comenzar</button>
        </div>
    </div>

    <div class="container" id="mainApp" style="display: none;">
        <!-- Barra de navegación -->
        <div class="navbar">
            <div class="stats">
                <div class="stat-box stat-total" data-filter="">
                    <div class="stat-value" id="totalCount">0</div>
                    <div class="stat-label">Total</div>
                </div>
                <div class="stat-box stat-unreviewed" data-filter="sin revisar">
                    <div class="stat-value" id="unreviewedCount">0</div>
                    <div class="stat-label">Sin Revisar</div>
                </div>
                <div class="stat-box stat-contactado" data-filter="contactado">
                    <div class="stat-value" id="contactadoCount">0</div>
                    <div class="stat-label">Contactado</div>
                </div>
                <div class="stat-box stat-jugando" data-filter="jugando">
                    <div class="stat-value" id="jugandoCount">0</div>
                    <div class="stat-label">Jugando</div>
                </div>
                <div class="stat-box stat-sin-wsp" data-filter="sin wsp">
                    <div class="stat-value" id="sinWspCount">0</div>
                    <div class="stat-label">Sin WSP</div>
                </div>
                <div class="stat-box stat-no-interesado" data-filter="no interesado">
                    <div class="stat-value" id="noInteresadoCount">0</div>
                    <div class="stat-label">No Interesado</div>
                </div>
                <div class="stat-box stat-duplicados" id="duplicatesStatBox">
                    <div class="stat-value" id="duplicatesCount">0</div>
                    <div class="stat-label">Duplicados</div>
                </div>
            </div>
            <div class="view-actions">
                <button id="viewCardsBtn" class="btn active"><i class="fas fa-th"></i> Tarjetas</button>
                <button id="viewListBtn" class="btn"><i class="fas fa-list"></i> Lista</button>
                <button id="timelineBtn" class="btn"><i class="fas fa-stream"></i> Timeline</button>
                <button id="exportBtn" class="btn"><i class="fas fa-download"></i> Exportar</button>
                <button id="historyBtn" class="btn"><i class="fas fa-history"></i> Historial</button>
                <button id="manageDuplicatesBtn" class="btn btn-warning"><i class="fas fa-clone"></i> Duplicados</button>
                <button id="shortcutsInfoBtn" class="btn"><i class="fas fa-keyboard"></i> Atajos</button>
                <button id="deleteAllBtn" class="btn btn-danger"><i class="fas fa-trash-alt"></i> Borrar Todo</button>
            </div>
        </div>

        <!-- Barra de progreso de revisión -->
        <div class="progress-bar-container" id="progressBarContainer">
            <div class="progress-header">
                <span class="progress-title">Progreso de revisión</span>
                <div style="text-align: right;">
                    <div class="progress-percentage" id="progressPercentage">0%</div>
                    <div class="progress-details"><span id="reviewedCount">0</span> revisados de <span id="totalContactsCount">0</span> totales</div>
                </div>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
        </div>

        <!-- Barra de búsqueda y filtros -->
        <div class="search-bar" style="position: relative;">
            <i class="fas fa-search" style="position: absolute; left: 35px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); pointer-events: none; z-index: 1;"></i>
            <input type="text" id="searchInput" class="search-input" placeholder="Buscar por nombre, teléfono o origen..." style="padding-left: 40px;">
            <div class="filter-group">
                <select id="statusFilter" class="filter-select">
                    <option value="">Todos los estados</option>
                    <option value="sin revisar">Sin Revisar</option>
                    <option value="contactado">Contactado</option>
                    <option value="jugando">Jugando</option>
                    <option value="sin wsp">Sin WhatsApp</option>
                    <option value="no interesado">No Interesado</option>
                </select>
                <select id="originFilter" class="filter-select"><option value="">Todos los orígenes</option></select>
                <button id="undoBtn" class="btn" title="Volver al último contacto editado (Ctrl+Z)">
                    <i class="fas fa-undo"></i> Volver
                </button>
                <button id="addMoreBtn" class="btn btn-success"><i class="fas fa-file-upload"></i> Importar CSV</button>
                <button id="addSingleBtn" class="btn btn-success"><i class="fas fa-user-plus"></i> Agregar Contacto</button>
            </div>
        </div>

        <!-- Barra de acciones masivas -->
        <div class="bulk-actions-bar" id="bulkActionsBar">
            <span class="bulk-count"><span id="selectedCount">0</span> seleccionados</span>
            <div class="bulk-actions">
                <select id="bulkStatusSelect" class="filter-select" style="min-width: 180px;"><option value="" disabled="" selected="">Cambiar estado</option><option value="sin revisar">Sin Revisar</option><option value="contactado">Contactado</option><option value="jugando">Jugando</option><option value="sin wsp">Sin WhatsApp</option><option value="no interesado">No Interesado</option></select>
                <button id="bulkDeleteBtn" class="btn btn-danger"><i class="fas fa-trash"></i> Eliminar</button>
                <button id="bulkCancelBtn" class="btn"><i class="fas fa-times"></i> Cancelar</button>
            </div>
        </div>

        <!-- Vista de tarjetas -->
        <div id="cardsView" class="cards-grid"></div>

        <!-- Vista de lista -->
        <div id="listView" class="list-view" style="display: none;"></div>


        <!-- Paginación -->
        <div class="pagination" id="pagination"></div>
    </div>

    <!-- Modal de exportación -->
    <div class="modal" id="exportModal">
        <div class="modal-content">
            <div class="modal-header"><i class="fas fa-download"></i> Exportar Contactos</div>
            <div class="export-options">
                <div class="export-option selected" data-type="filtered">
                    <i class="fas fa-filter"></i>
                    <div class="export-option-text">
                        <div class="export-option-title">Exportar filtrados</div>
                        <div class="export-option-desc"><span id="exportFilteredCount">0</span> contactos visibles</div>
                    </div>
                </div>
                <div class="export-option" data-type="all">
                    <i class="fas fa-users"></i>
                    <div class="export-option-text">
                        <div class="export-option-title">Exportar todos</div>
                        <div class="export-option-desc"><span id="exportAllCount">0</span> contactos totales</div>
                    </div>
                </div>
            </div>
            <div class="export-options">
                <div class="export-option selected" data-format="excel">
                    <i class="fas fa-file-excel"></i>
                    <div class="export-option-text">
                        <div class="export-option-title">Excel (CSV)</div>
                        <div class="export-option-desc">Compatible con Excel y Google Sheets</div>
                    </div>
                </div>
                <div class="export-option" data-format="vcf">
                    <i class="fas fa-address-card"></i>
                    <div class="export-option-text">
                        <div class="export-option-title">VCF (Contactos)</div>
                        <div class="export-option-desc">Importable directamente a WhatsApp</div>
                    </div>
                </div>
                <div class="export-option" data-format="sheet">
                    <i class="fas fa-table"></i>
                    <div class="export-option-text">
                        <div class="export-option-title">Formato Planilla</div>
                        <div class="export-option-desc">Formato personalizado con columnas especiales</div>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button id="cancelExport" class="btn"><i class="fas fa-times"></i> Cancelar</button>
                <button id="confirmExport" class="btn btn-success"><i class="fas fa-download"></i> Exportar</button>
            </div>
        </div>
    </div>

    <!-- Modal de duplicados -->
    <div class="modal" id="duplicatesModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header"><i class="fas fa-clone"></i> Gestionar Duplicados</div>
            <div id="duplicatesContent">
                <p style="color: var(--text-secondary); margin: 20px 0;">Detectando duplicados...</p>
            </div>
            <div class="modal-actions">
                <button id="closeDuplicatesModal" class="btn"><i class="fas fa-times"></i> Cerrar</button>
                <button id="mergeAllDuplicates" class="btn btn-success" style="display: none;"><i class="fas fa-compress-alt"></i> Fusionar Todos</button>
            </div>
        </div>
    </div>

    <!-- Modal de historial -->
    <div class="modal" id="historyModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header"><i class="fas fa-history"></i> Historial de Cambios</div>
            <div class="history-list" id="historyList"></div>
            <div class="modal-actions">
                <button id="closeHistoryModal" class="btn"><i class="fas fa-times"></i> Cerrar</button>
                <button id="clearHistoryBtn" class="btn btn-danger"><i class="fas fa-trash"></i> Borrar Historial</button>
            </div>
        </div>
    </div>


    <div class="modal" id="shortcutsModal">
        <div class="modal-content" style="max-width:700px;">
            <div class="modal-header"><i class="fas fa-keyboard"></i> Atajos de Teclado (Numpad)</div>
            <p style="color: var(--text-secondary);">Se evita usar números superiores para no interferir con macros de trabajo.</p>
            <div class="shortcut-list">
                <div class="shortcut-item"><kbd>Numpad 1</kbd> Estado: Sin revisar</div>
                <div class="shortcut-item"><kbd>Numpad 2</kbd> Estado: Contactado</div>
                <div class="shortcut-item"><kbd>Numpad 3</kbd> Estado: Jugando</div>
                <div class="shortcut-item"><kbd>Numpad 4</kbd> Estado: Sin WSP</div>
                <div class="shortcut-item"><kbd>Numpad 5</kbd> Estado: No interesado</div>
                <div class="shortcut-item"><kbd>Numpad 0</kbd> Volver al último contacto</div>
                <div class="shortcut-item"><kbd>Numpad +</kbd> Cambiar a vista Lista</div>
                <div class="shortcut-item"><kbd>Numpad -</kbd> Cambiar a vista Timeline</div>
            </div>
            <div class="modal-actions">
                <button id="closeShortcutsModal" class="btn btn-success"><i class="fas fa-check"></i> Entendido</button>
            </div>
        </div>
    </div>


    <div class="modal" id="timelineModal">
        <div class="modal-content" style="max-width: 760px;">
            <div class="modal-header"><i class="fas fa-stream"></i> Timeline de Interacciones</div>
            <div id="timelineContent"></div>
            <div class="modal-actions">
                <button id="closeTimelineModal" class="btn"><i class="fas fa-times"></i> Cerrar</button>
            </div>
        </div>
    </div>


    <div class="modal" id="importOptionsModal">
        <div class="modal-content" style="max-width: 480px;">
            <div class="modal-header"><i class="fas fa-sliders-h"></i> Opciones de Importación</div>
            <div class="export-options">
                <div class="export-option" id="openImportFilesOption">
                    <i class="fas fa-file-upload"></i>
                    <div class="export-option-text">
                        <div class="export-option-title">Subir nuevo usuario (CSV/VCF)</div>
                        <div class="export-option-desc">Abrir pantalla para cargar archivos</div>
                    </div>
                </div>
                <div class="export-option" id="openWhatsappMessageOption">
                    <i class="fab fa-whatsapp"></i>
                    <div class="export-option-text">
                        <div class="export-option-title">Cambiar mensaje WhatsApp</div>
                        <div class="export-option-desc">Editar plantilla con token {usuario}</div>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button id="closeImportOptionsModal" class="btn"><i class="fas fa-times"></i> Cerrar</button>
            </div>
        </div>
    </div>

    <div class="modal" id="whatsappMessageModal">
        <div class="modal-content" style="max-width: 640px;">
            <div class="modal-header"><i class="fab fa-whatsapp"></i> Mensaje de WhatsApp</div>
            <textarea id="whatsappTemplateInput" class="origin-input" style="min-height: 140px; margin-top: 0;" placeholder="Hola {usuario}, ..."></textarea>
            <div class="template-actions" style="margin-top: 12px;">
                <button id="insertUserTokenBtn" class="btn"><i class="fas fa-user"></i> Insertar usuario</button>
                <button id="resetTemplateBtn" class="btn"><i class="fas fa-undo"></i> Restablecer</button>
            </div>
            <p class="template-help" style="margin-top: 8px;">Usá <code>{usuario}</code> para completar el nombre automáticamente.</p>
            <div class="modal-actions">
                <button id="closeWhatsappMessageModal" class="btn"><i class="fas fa-times"></i> Cancelar</button>
                <button id="saveTemplateBtn" class="btn btn-success"><i class="fas fa-save"></i> Guardar mensaje</button>
            </div>
        </div>
    </div>

    <!-- Modal de agregar contacto único -->
    <div class="modal" id="addSingleModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header"><i class="fas fa-user-plus"></i> Agregar Contacto</div>
            <div style="display: flex; flex-direction: column; gap: 15px; margin: 20px 0;">
                <input type="text" id="singleName" class="origin-input" placeholder="Nombre del contacto" style="margin-top: 0;">
                <input type="text" id="singlePhone" class="origin-input" placeholder="Teléfono (opcional)" style="margin-top: 0;">
                <input type="text" id="singleOrigin" class="origin-input" placeholder="Origen (opcional)" style="margin-top: 0;">
                <select id="singleStatus" class="filter-select">
                    <option value="sin revisar">Sin Revisar</option>
                    <option value="contactado">Contactado</option>
                    <option value="jugando">Jugando</option>
                    <option value="sin wsp">Sin WhatsApp</option>
                    <option value="no interesado">No Interesado</option>
                </select>
            </div>
            <div class="modal-actions">
                <button id="cancelAddSingle" class="btn"><i class="fas fa-times"></i> Cancelar</button>
                <button id="confirmAddSingle" class="btn btn-success"><i class="fas fa-plus"></i> Agregar</button>
            </div>
        </div>
    </div>

    <script>
    (() => {
        const $ = (sel) => document.querySelector(sel);
        const $$ = (sel) => document.querySelectorAll(sel);

        const STATUS_OPTIONS = [
            { id: 'sin revisar', label: 'Sin Revisar', icon: 'fa-question-circle', color: '#9ca3af', rgb: '156, 163, 175' },
            { id: 'contactado', label: 'Contactado', icon: 'fa-check-circle', color: '#10b981', rgb: '16, 185, 129' },
            { id: 'jugando', label: 'Jugando', icon: 'fa-gamepad', color: '#8b5cf6', rgb: '139, 92, 246' },
            { id: 'sin wsp', label: 'Sin WhatsApp', icon: 'fa-ban', color: '#f59e0b', rgb: '245, 158, 11' },
            { id: 'no interesado', label: 'No Interesado', icon: 'fa-times-circle', color: '#ef4444', rgb: '239, 68, 68' }
        ];

        const AppState = {
            contacts: [],
            filteredContacts: [],
            selectedContacts: new Set(),
            currentPage: 1,
            itemsPerPage: 20,
            searchTerm: '',
            statusFilter: '',
            originFilter: '',
            sortBy: 'name',
            sortOrder: 'asc',
            duplicates: [],
            history: [],
            lastEditedContact: null,
            undoStack: [],
            currentView: 'cards',
            whatsappTemplate: 'Hola {usuario}, ¿cómo estás? Te escribo por la propuesta que vimos.',
            duplicateMergeMode: 'phone-auto'
        };

        const elements = {
            uploadScreen: $('#uploadScreen'),
            mainApp: $('#mainApp'),
            fileInput: $('#fileInput'),
            uploadArea: $('#uploadArea'),
            fileList: $('#fileList'),
            originInput: $('#originInput'),
            startBtn: $('#startBtn'),
            cardsView: $('#cardsView'),
            listView: $('#listView'),
            searchInput: $('#searchInput'),
            statusFilter: $('#statusFilter'),
            originFilter: $('#originFilter'),
            viewCardsBtn: $('#viewCardsBtn'),
            viewListBtn: $('#viewListBtn'),
            timelineBtn: $('#timelineBtn'),
            exportBtn: $('#exportBtn'),
            bulkActionsBar: $('#bulkActionsBar'),
            selectedCount: $('#selectedCount'),
            bulkStatusSelect: $('#bulkStatusSelect'),
            pagination: $('#pagination'),
            manageDuplicatesBtn: $('#manageDuplicatesBtn'),
            duplicatesModal: $('#duplicatesModal'),
            duplicatesStatBox: $('#duplicatesStatBox'),
            addMoreBtn: $('#addMoreBtn'),
            addSingleBtn: $('#addSingleBtn'),
            historyBtn: $('#historyBtn'),
            historyModal: $('#historyModal'),
            deleteAllBtn: $('#deleteAllBtn'),
            undoBtn: $('#undoBtn'),
            whatsappTemplateInput: $('#whatsappTemplateInput'),
            saveTemplateBtn: $('#saveTemplateBtn'),
            insertUserTokenBtn: $('#insertUserTokenBtn'),
            resetTemplateBtn: $('#resetTemplateBtn'),
            shortcutsInfoBtn: $('#shortcutsInfoBtn'),
            shortcutsModal: $('#shortcutsModal'),
            importOptionsModal: $('#importOptionsModal'),
            whatsappMessageModal: $('#whatsappMessageModal')
        };

        let selectedFiles = [];

        function normalizePhoneNumber(phone) {
            if (!phone) return '';
            return phone.toString().replace(/\D/g, '');
        }

        function normalizeUsername(name) {
            if (!name) return '';
            return name.toString().toLowerCase().trim();
        }

        function addToHistory(action, details) {
            const historyEntry = {
                timestamp: new Date().toISOString(),
                action: action,
                details: details
            };
            AppState.history.unshift(historyEntry);
            if (AppState.history.length > 50) {
                AppState.history = AppState.history.slice(0, 50);
            }
            saveHistory();
        }

        function saveHistory() {
            try {
                localStorage.setItem('contactsHistory', JSON.stringify(AppState.history));
            } catch (e) {
                console.error('Error al guardar historial:', e);
            }
        }

        function loadHistory() {
            try {
                const saved = localStorage.getItem('contactsHistory');
                if (saved) {
                    AppState.history = JSON.parse(saved);
                }
            } catch (e) {
                console.error('Error al cargar historial:', e);
            }
        }

        function mergeContact(existing, newContact) {
            const merged = { ...existing };
            
            merged.name = existing.name || newContact.name;
            
            if (newContact.phone && !existing.phone) {
                merged.phone = newContact.phone;
            } else if (existing.phone) {
                merged.phone = existing.phone;
            }
            
            if (newContact.origin && !existing.origin) {
                merged.origin = newContact.origin;
            } else if (existing.origin) {
                merged.origin = existing.origin;
            }
            
            const statusPriority = {
                'jugando': 5,
                'contactado': 4,
                'sin wsp': 3,
                'sin revisar': 2,
                'no interesado': 1
            };
            
            const existingPriority = statusPriority[existing.status] || 0;
            const newPriority = statusPriority[newContact.status] || 0;
            
            if (newPriority > existingPriority) {
                merged.status = newContact.status;
                merged.lastUpdated = new Date().toISOString();
            } else {
                merged.status = existing.status;
            }
            
            return merged;
        }

        function detectDuplicates() {
            const nameMap = new Map();
            const phoneMap = new Map();
            const duplicateGroups = [];
            const duplicateIds = new Set();

            // Agrupar por nombre normalizado
            AppState.contacts.forEach(contact => {
                const normalizedName = normalizeUsername(contact.name);
                if (!nameMap.has(normalizedName)) {
                    nameMap.set(normalizedName, []);
                }
                nameMap.get(normalizedName).push(contact);
            });

            // Agrupar por teléfono
            AppState.contacts.forEach(contact => {
                if (contact.phone) {
                    const normalizedPhone = normalizePhoneNumber(contact.phone);
                    if (!phoneMap.has(normalizedPhone)) {
                        phoneMap.set(normalizedPhone, []);
                    }
                    phoneMap.get(normalizedPhone).push(contact);
                }
            });

            // Detectar duplicados por nombre
            nameMap.forEach((contacts, name) => {
                if (contacts.length > 1) {
                    duplicateGroups.push({
                        type: 'nombre',
                        name: contacts[0].name,
                        contacts: contacts
                    });
                    contacts.forEach(c => duplicateIds.add(c.id));
                }
            });

            // Detectar duplicados por teléfono
            phoneMap.forEach((contacts, phone) => {
                if (contacts.length > 1) {
                    const uniqueNames = new Set(contacts.map(c => normalizeUsername(c.name)));
                    if (uniqueNames.size > 1) {
                        duplicateGroups.push({
                            type: 'teléfono',
                            name: `Teléfono: ${contacts[0].phone}`,
                            contacts: contacts
                        });
                        contacts.forEach(c => duplicateIds.add(c.id));
                    }
                }
            });

            AppState.duplicates = duplicateGroups;
            
            // Marcar contactos duplicados
            AppState.contacts.forEach(contact => {
                contact.isDuplicate = duplicateIds.has(contact.id);
            });

            return duplicateGroups;
        }

        function parseCSV(text) {
            // Detectar si es VCF
            if (text.trim().startsWith('BEGIN:VCARD')) {
                return parseVCF(text);
            }
            
            const lines = text.split('\n').filter(line => line.trim());
            if (lines.length === 0) return [];
            
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, '').toLowerCase());
            const contacts = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                const contact = {};
                
                headers.forEach((header, index) => {
                    const value = values[index] || '';
                    
                    if (header.includes('nombre') || header.includes('usuario')) {
                        contact.name = value;
                    } else if (header.includes('tel') || header.includes('phone') || header.includes('número')) {
                        contact.phone = normalizePhoneNumber(value);
                    } else if (header.includes('estado') && !header.includes('revision')) {
                        const lowerValue = value.toLowerCase();
                        if (lowerValue.includes('promo enviada') || lowerValue.includes('contactado')) {
                            contact.status = 'contactado';
                        } else if (lowerValue.includes('no esta en wsp') || lowerValue.includes('sin wsp')) {
                            contact.status = 'sin wsp';
                        } else if (lowerValue.includes('en contacto') || lowerValue.includes('jugando')) {
                            contact.status = 'jugando';
                        } else if (lowerValue.includes('eliminado') || lowerValue.includes('no interesado')) {
                            contact.status = 'no interesado';
                        } else if (lowerValue.includes('a contactar') || lowerValue.includes('sin revisar')) {
                            contact.status = 'sin revisar';
                        }
                    }
                });
                
                if (contact.name) {
                    contacts.push(contact);
                }
            }
            
            return contacts;
        }

        function loadFiles() {
            const origin = elements.originInput.value.trim() || 'Sin especificar';
            let totalNewContacts = 0;
            let totalMerged = 0;
            let filesProcessed = 0;

            if (selectedFiles.length === 0) return;

            selectedFiles.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const parsedContacts = parseCSV(e.target.result);
                    
                    parsedContacts.forEach(newContact => {
                        const normalizedName = normalizeUsername(newContact.name);
                        const normalizedPhone = normalizePhoneNumber(newContact.phone);
                        
                        const existingIndex = AppState.contacts.findIndex(c => 
                            normalizeUsername(c.name) === normalizedName ||
                            (normalizedPhone && normalizePhoneNumber(c.phone) === normalizedPhone)
                        );
                        
                        if (existingIndex !== -1) {
                            const oldContact = { ...AppState.contacts[existingIndex] };
                            AppState.contacts[existingIndex] = mergeContact(
                                AppState.contacts[existingIndex],
                                {
                                    ...newContact,
                                    origin: origin,
                                    status: newContact.status || 'sin revisar'
                                }
                            );
                            addToHistory('Merge de contacto', `${newContact.name} actualizado`);
                            totalMerged++;
                        } else {
                            const newId = Date.now() + Math.random();
                            AppState.contacts.push({
                                id: newId,
                                name: newContact.name,
                                phone: newContact.phone || '',
                                origin: origin,
                                status: newContact.status || 'sin revisar',
                                lastUpdated: new Date().toISOString(),
                                isDuplicate: false
                            });
                            addToHistory('Contacto agregado', newContact.name);
                            totalNewContacts++;
                        }
                    });

                    filesProcessed++;
                    if (filesProcessed === selectedFiles.length) {
                        detectDuplicates();
                        saveData();
                        elements.uploadScreen.classList.add('hidden');
                        elements.mainApp.style.display = 'block';
                        render();
                        showNotification(
                            `✅ ${totalNewContacts} contactos nuevos, ${totalMerged} actualizados`,
                            'success'
                        );
                        selectedFiles = [];
                        elements.fileInput.value = '';
                        elements.fileList.innerHTML = '';
                    }
                };
                reader.readAsText(file);
            });
        }

        function manageAutomaticBackup() {
            if (!AppState.contacts || AppState.contacts.length === 0) return;

            const now = new Date();
            const hour = now.getHours();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const dateStr = `${year}-${month}-${day}`;

            let slot;
            if (hour >= 6 && hour < 14) slot = 'tm';
            else if (hour >= 14 && hour < 22) slot = 'tt';
            else slot = 'tn';

            const backupKey = `bk_${slot}_${dateStr}`;
            if (localStorage.getItem(backupKey)) return;

            try {
                const backupData = JSON.stringify(AppState.contacts);
                localStorage.setItem(backupKey, backupData);
                console.log(`Backup automático creado: ${backupKey}`);
                
                const yesterday = new Date(now);
                yesterday.setDate(now.getDate() - 1);
                const prevYear = yesterday.getFullYear();
                const prevMonth = String(yesterday.getMonth() + 1).padStart(2, '0');
                const prevDay = String(yesterday.getDate()).padStart(2, '0');
                const prevDateStr = `${prevYear}-${prevMonth}-${prevDay}`;
                const oldBackupKey = `bk_${slot}_${prevDateStr}`;
                if(localStorage.getItem(oldBackupKey)) {
                    localStorage.removeItem(oldBackupKey);
                    console.log(`Backup antiguo eliminado: ${oldBackupKey}`);
                }
            } catch (e) {
                console.error('Error al crear backup automático:', e);
            }
        }

        function saveData() {
            try {
                localStorage.setItem('contactsData', JSON.stringify(AppState.contacts));
                manageAutomaticBackup();
            } catch (e) {
                console.error('Error al guardar datos:', e);
                showNotification('⚠️ Error al guardar datos.', 'error');
            }
        }

        function loadData() {
            try {
                const saved = localStorage.getItem('contactsData');
                if (saved) {
                    AppState.contacts = JSON.parse(saved);
                    if (AppState.contacts.length > 0) {
                        detectDuplicates();
                        elements.uploadScreen.classList.add('hidden');
                        elements.mainApp.style.display = 'block';
                        render();
                        manageAutomaticBackup();
                    } else {
                        elements.uploadScreen.classList.remove('hidden');
                    }
                } else {
                    elements.uploadScreen.classList.remove('hidden');
                }
            } catch (e) {
                console.error('Error al cargar datos:', e);
                elements.uploadScreen.classList.remove('hidden');
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            const icons = { success: 'fa-check-circle', error: 'fa-exclamation-circle', info: 'fa-info-circle' };
            notification.innerHTML = `<i class="fas ${icons[type]}"></i><span>${message}</span>`;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 4000);
        }

        function applyFilters() {
            AppState.filteredContacts = AppState.contacts.filter(contact => {
                const searchTerm = AppState.searchTerm.toLowerCase();
                const matchesSearch = !searchTerm || 
                    (contact.name && contact.name.toLowerCase().includes(searchTerm)) ||
                    (contact.phone && contact.phone.includes(searchTerm)) ||
                    (contact.origin && contact.origin.toLowerCase().includes(searchTerm));
                
                const matchesStatus = !AppState.statusFilter || contact.status === AppState.statusFilter;
                const matchesOrigin = !AppState.originFilter || contact.origin === AppState.originFilter;
                
                return matchesSearch && matchesStatus && matchesOrigin;
            });
            
        }

        function updateStats() {
            $('#totalCount').textContent = AppState.contacts.length;
            $('#unreviewedCount').textContent = AppState.contacts.filter(c => c.status === 'sin revisar').length;
            $('#contactadoCount').textContent = AppState.contacts.filter(c => c.status === 'contactado').length;
            $('#jugandoCount').textContent = AppState.contacts.filter(c => c.status === 'jugando').length;
            $('#sinWspCount').textContent = AppState.contacts.filter(c => c.status === 'sin wsp').length;
            $('#noInteresadoCount').textContent = AppState.contacts.filter(c => c.status === 'no interesado').length;
            
            const duplicateGroups = detectDuplicates();
            const totalDuplicateEntries = duplicateGroups.reduce((sum, group) => sum + group.contacts.length, 0);
            $('#duplicatesCount').textContent = totalDuplicateEntries;
            
            // Actualizar barra de progreso
            const totalContacts = AppState.contacts.length;
            const reviewedContacts = AppState.contacts.filter(c => c.status !== 'sin revisar').length;
            const progressPercentage = totalContacts > 0 ? Math.round((reviewedContacts / totalContacts) * 100) : 0;
            
            $('#reviewedCount').textContent = reviewedContacts;
            $('#totalContactsCount').textContent = totalContacts;
            $('#progressPercentage').textContent = `${progressPercentage}%`;
            $('#progressFill').style.width = `${progressPercentage}%`;
            
            const uniqueOrigins = [...new Set(AppState.contacts.map(c => c.origin).filter(Boolean))].sort();
            elements.originFilter.innerHTML = '<option value="">Todos los orígenes</option>' + 
                uniqueOrigins.map(o => `<option value="${o}">${o}</option>`).join('');
            elements.originFilter.value = AppState.originFilter;
        }

        function getStatusOption(status) {
            return STATUS_OPTIONS.find(s => s.id === status) || STATUS_OPTIONS[0];
        }

        function createCard(contact) {
            const statusOption = getStatusOption(contact.status);
            const escapedName = (contact.name || '').replace(/'/g, "\\'");
            const escapedPhone = (contact.phone || '').replace(/'/g, "\\'");
            
            return `
                <div class="contact-card ${AppState.selectedContacts.has(contact.id) ? 'selected' : ''} ${contact.isDuplicate ? 'duplicate' : ''}" style="--status-rgb: ${statusOption.rgb};" data-id="${contact.id}">
                    ${contact.isDuplicate ? '<span class="duplicate-badge"><i class="fas fa-exclamation-triangle"></i> DUP</span>' : ''}
                    <input type="checkbox" class="card-checkbox" ${AppState.selectedContacts.has(contact.id) ? 'checked' : ''}>
                    <div class="card-header">
                        <div class="card-icon" style="color: ${statusOption.color};">
                            <i class="fas ${statusOption.icon}"></i>
                        </div>
                        <div style="flex: 1; display: flex; align-items: center; gap: 8px;">
                            <span class="card-name" onclick="copyToClipboard('${escapedName}', event)" style="cursor: pointer; flex: 1;" title="Click para copiar">${contact.name}</span>
                            <button class="btn" style="padding: 4px 8px; font-size: 0.75rem;" onclick="editContactField(${contact.id}, 'name', event)" title="Editar nombre">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-details">
                        ${contact.phone ? `
                            <div class="detail-item">
                                <i class="fas fa-phone"></i>
                                <span onclick="copyToClipboard('${escapedPhone}', event)" style="cursor: pointer; flex: 1;" title="Click para copiar">${contact.phone}</span>
                                <button class="btn" style="padding: 4px 8px; font-size: 0.7rem;" onclick="editContactField(${contact.id}, 'phone', event)" title="Editar">
                                    <i class="fas fa-pencil-alt"></i>
                                </button>
                                <button class="btn btn-success" style="padding: 4px 8px; font-size: 0.7rem;" onclick="openWhatsApp('${escapedPhone}', event)" title="WhatsApp">
                                    <i class="fab fa-whatsapp"></i>
                                </button>
                            </div>
                        ` : '<div class="detail-item"><i class="fas fa-phone"></i><span style="color: var(--text-secondary);">Sin teléfono</span></div>'}
                        <div class="detail-item"><i class="fas fa-tag"></i><span>${contact.origin}</span></div>
                        <div class="detail-item">
                            <i class="fas fa-circle-notch"></i>
                            <span class="card-status-inline" id="cardStatusInline-${contact.id}"><span class="status-badge status-${contact.status.replace(/ /g, '-')}" onclick="openCardStatusMenu(${contact.id}, event)">${statusOption.label}</span></span>
                        </div>
                    </div>
                    <div class="card-footer">
                        <span><i class="fas fa-calendar"></i> ${new Date(contact.lastUpdated).toLocaleDateString('es-ES')}</span>
                        <button class="btn btn-danger" style="padding: 5px 10px; font-size: 0.75rem;" onclick="deleteContact(${contact.id}, event)"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `;
        }

        function createListItem(contact) {
            const statusOption = getStatusOption(contact.status);
            const escapedName = (contact.name || '').replace(/'/g, "\\'");
            const escapedPhone = (contact.phone || '').replace(/'/g, "\\'");
            
            return `
                <div class="list-item ${AppState.selectedContacts.has(contact.id) ? 'selected' : ''} ${contact.isDuplicate ? 'duplicate' : ''}" style="--status-rgb: ${statusOption.rgb};" data-id="${contact.id}">
                    <div><input type="checkbox" ${AppState.selectedContacts.has(contact.id) ? 'checked' : ''}></div>
                    <div class="list-item-name list-item-main" style="--status-color: ${statusOption.color}; --status-rgb: ${statusOption.rgb};">
                        <i class="fas ${statusOption.icon} list-status-bg-icon"></i>
                        <div class="list-name-row">
                            <span onclick="copyToClipboard('${escapedName}', event)" style="flex: 1; cursor: pointer;" title="Click para copiar">
                                ${contact.isDuplicate ? '<i class="fas fa-exclamation-triangle" style="color: var(--accent-warning);"></i> ' : ''}${contact.name}
                            </span>
                            <button class="btn" style="padding: 4px 8px; font-size: 0.75rem;" onclick="editContactField(${contact.id}, 'name', event)" title="Editar">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                        </div>
                        <span class="list-status-chip"><i class="fas ${statusOption.icon}"></i>${statusOption.label}</span>
                    </div>
                    <div class="list-item-phone">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span onclick="copyToClipboard('${escapedPhone}', event)" style="flex: 1; font-family: monospace; cursor: pointer;" title="Click para copiar">${contact.phone || 'Sin teléfono'}</span>
                            ${contact.phone ? `
                                <button class="btn" style="padding: 4px 8px; font-size: 0.75rem;" onclick="editContactField(${contact.id}, 'phone', event)" title="Editar">
                                    <i class="fas fa-pencil-alt"></i>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                    <div class="list-item-origin">${contact.origin}</div>
                    <div class="list-item-date">${new Date(contact.lastUpdated).toLocaleDateString('es-ES')}</div>
                    <div class="whatsapp-cell">
                        ${contact.phone ? `
                            <button class="btn whatsapp-btn" onclick="openWhatsApp('${escapedPhone}', event)" title="Abrir WhatsApp">
                                <i class="fab fa-whatsapp"></i>
                            </button>
                        ` : '<span style="color: var(--text-secondary); font-size: 0.8rem;">-</span>'}
                    </div>
                    <div class="status-buttons">
                        <button class="status-btn sin-revisar ${contact.status === 'sin revisar' ? 'active' : ''}" 
                                onclick="changeContactStatus(${contact.id}, 'sin revisar', event)" 
                                title="Sin Revisar">
                            <i class="fas fa-circle"></i>
                        </button>
                        <button class="status-btn contactado ${contact.status === 'contactado' ? 'active' : ''}" 
                                onclick="changeContactStatus(${contact.id}, 'contactado', event)" 
                                title="Contactado">
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="status-btn jugando ${contact.status === 'jugando' ? 'active' : ''}" 
                                onclick="changeContactStatus(${contact.id}, 'jugando', event)" 
                                title="Jugando">
                            <i class="fas fa-gamepad"></i>
                        </button>
                        <button class="status-btn sin-wsp ${contact.status === 'sin wsp' ? 'active' : ''}" 
                                onclick="changeContactStatus(${contact.id}, 'sin wsp', event)" 
                                title="Sin WhatsApp">
                            <i class="fas fa-ban"></i>
                        </button>
                        <button class="status-btn no-interesado ${contact.status === 'no interesado' ? 'active' : ''}" 
                                onclick="changeContactStatus(${contact.id}, 'no interesado', event)" 
                                title="No Interesado">
                            <i class="fas fa-times"></i>
                        </button>
                        <button class="btn btn-danger" style="padding: 0; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;" onclick="deleteContact(${contact.id}, event)" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        function renderPaginatedView(renderFunc) {
            const start = (AppState.currentPage - 1) * AppState.itemsPerPage;
            const end = start + AppState.itemsPerPage;
            const pageContacts = AppState.filteredContacts.slice(start, end);
            
            if (pageContacts.length === 0 && AppState.filteredContacts.length > 0 && AppState.currentPage > 1) {
                AppState.currentPage = 1;
                renderPaginatedView(renderFunc);
                return;
            }
            
            if (AppState.currentView === 'cards') {
                elements.cardsView.innerHTML = pageContacts.length > 0 
                    ? pageContacts.map(renderFunc).join('') 
                    : '<div style="text-align: center; padding: 50px; color: var(--text-secondary); grid-column: 1 / -1;">No se encontraron contactos</div>';
            } else {
                const listItems = pageContacts.map(renderFunc).join('');
                elements.listView.innerHTML = `
                    <div class="list-header">
                        <div><input type="checkbox" id="selectAllCheckbox"></div>
                        <div>Nombre</div>
                        <div>Teléfono</div>
                        <div>Origen</div>
                        <div>Fecha</div>
                        <div>WhatsApp</div>
                        <div>Acciones</div>
                    </div>
                    ${listItems || '<div style="text-align: center; padding: 50px; color: var(--text-secondary); grid-column: 1 / -1;">No se encontraron contactos</div>'}
                `;
                
                const selectAllCheckbox = $('#selectAllCheckbox');
                if (selectAllCheckbox) {
                    const areAllOnPageSelected = pageContacts.length > 0 && pageContacts.every(c => AppState.selectedContacts.has(c.id));
                    selectAllCheckbox.checked = areAllOnPageSelected;
                    selectAllCheckbox.onchange = (e) => {
                        pageContacts.forEach(c => {
                            if (e.target.checked) AppState.selectedContacts.add(c.id);
                            else AppState.selectedContacts.delete(c.id);
                        });
                        renderPaginatedView(createListItem);
                        updateBulkActionsBar();
                    };
                }
            }
            
            renderPagination();
        }

        function renderPagination() {
            const totalPages = Math.ceil(AppState.filteredContacts.length / AppState.itemsPerPage);
            if (totalPages <= 1) {
                elements.pagination.innerHTML = '';
                return;
            }
            let html = '';
            
            html += `<button ${AppState.currentPage === 1 ? 'disabled' : ''} onclick="changePage(${AppState.currentPage - 1})"><i class="fas fa-chevron-left"></i></button>`;
            
            const pagesToShow = [];
            pagesToShow.push(1);
            if (AppState.currentPage > 4) pagesToShow.push('...');
            for (let i = Math.max(2, AppState.currentPage - 2); i <= Math.min(totalPages - 1, AppState.currentPage + 2); i++) {
                pagesToShow.push(i);
            }
            if (AppState.currentPage < totalPages - 3) pagesToShow.push('...');
            if(totalPages > 1) pagesToShow.push(totalPages);

            const uniquePages = [...new Set(pagesToShow)];

            uniquePages.forEach(p => {
                if (p === '...') {
                    html += '<span class="page-info">...</span>';
                } else {
                    html += `<button class="${p === AppState.currentPage ? 'active' : ''}" onclick="changePage(${p})">${p}</button>`;
                }
            });

            html += `<button ${AppState.currentPage === totalPages ? 'disabled' : ''} onclick="changePage(${AppState.currentPage + 1})"><i class="fas fa-chevron-right"></i></button>`;
            html += `<span class="page-info">Página ${AppState.currentPage} de ${totalPages} (${AppState.filteredContacts.length} contactos)</span>`;
            
            elements.pagination.innerHTML = html;
        }

        window.changePage = (page) => {
            if (page < 1 || page > Math.ceil(AppState.filteredContacts.length / AppState.itemsPerPage)) return;
            AppState.currentPage = page;
            renderPaginatedView(AppState.currentView === 'cards' ? createCard : createListItem);
        };

        window.deleteContact = (id, event) => {
            if (event) event.stopPropagation();
            const contact = AppState.contacts.find(c => c.id === id);
            if (contact && confirm(`¿Eliminar "${contact.name}"?`)) {
                AppState.contacts = AppState.contacts.filter(c => c.id !== id);
                AppState.selectedContacts.delete(id);
                addToHistory('Contacto eliminado', contact.name);
                saveData();
                render();
                showNotification('Contacto eliminado', 'success');
            }
        };

        window.copyToClipboard = (text, event) => {
            if (event) event.stopPropagation();
            navigator.clipboard.writeText(text).then(() => {
                showNotification(`✓ Copiado: ${text}`, 'success');
            }).catch(() => {
                showNotification('Error al copiar', 'error');
            });
        };

        window.changeContactStatus = (id, newStatus, event) => {
            if (event) event.stopPropagation();
            const contact = AppState.contacts.find(c => c.id === id);
            if (!contact) return;

            const oldStatus = contact.status;
            if (oldStatus === newStatus) return;

            contact.status = newStatus;
            contact.lastUpdated = new Date().toISOString();
            AppState.lastEditedContact = id;
            addToHistory('Estado cambiado', `${contact.name}: ${oldStatus} → ${newStatus}`);
            saveData();
            render();
        };

        window.editContactField = (id, field, event) => {
            if (event) event.stopPropagation();
            const contact = AppState.contacts.find(c => c.id === id);
            if (!contact) return;

            const currentValue = contact[field] || '';
            const newValue = prompt(`Editar ${field === 'name' ? 'nombre' : 'teléfono'}:`, currentValue);
            
            if (newValue !== null && newValue !== currentValue) {
                const oldValue = contact[field];
                contact[field] = field === 'phone' ? normalizePhoneNumber(newValue) : newValue;
                contact.lastUpdated = new Date().toISOString();
                AppState.lastEditedContact = id;
                addToHistory(`${field} editado`, `${contact.name}: ${oldValue} → ${contact[field]}`);
                saveData();
                render();
                showNotification('Contacto actualizado', 'success');
            }
        };

        function undoToLastContact() {
            if (AppState.lastEditedContact) {
                const contact = AppState.contacts.find(c => c.id === AppState.lastEditedContact);
                if (contact) {
                    elements.searchInput.value = contact.name;
                    AppState.searchTerm = contact.name;
                    render();
                    showNotification(`📍 Mostrando: ${contact.name}`, 'info');
                } else {
                    showNotification('El último contacto editado ya no existe', 'error');
                }
            } else {
                showNotification('No hay contactos editados recientemente', 'info');
            }
        }

        function loadPreferences() {
            try {
                const tpl = localStorage.getItem('whatsappTemplate');
                if (tpl) AppState.whatsappTemplate = tpl;
                const mode = localStorage.getItem('duplicateMergeMode');
                if (mode) AppState.duplicateMergeMode = mode;
            } catch (e) {
                console.error('Error al cargar preferencias:', e);
            }
            if (elements.whatsappTemplateInput) {
                elements.whatsappTemplateInput.value = AppState.whatsappTemplate;
            }
        }

        function savePreferences() {
            try {
                localStorage.setItem('whatsappTemplate', AppState.whatsappTemplate);
                localStorage.setItem('duplicateMergeMode', AppState.duplicateMergeMode);
            } catch (e) {
                console.error('Error al guardar preferencias:', e);
            }
        }

        function buildWhatsAppMessage(contactName) {
            const base = (AppState.whatsappTemplate || '').trim();
            return base.replaceAll('{usuario}', contactName || '');
        }

        function createTimelineView() {
            const timelineContent = $('#timelineContent');
            if (!timelineContent) return;
            if (!AppState.history.length) {
                timelineContent.innerHTML = '<p style="color: var(--text-secondary);">No hay eventos todavía.</p>';
                return;
            }
            const grouped = {};
            AppState.history.forEach(item => {
                const d = new Date(item.timestamp);
                const key = d.toLocaleDateString('es-ES');
                if (!grouped[key]) grouped[key] = [];
                grouped[key].push(item);
            });
            const html = Object.entries(grouped).map(([day, items]) => `
                <div class="timeline-day">
                    <div class="timeline-day-title">${day}</div>
                    ${items.map(ev => `<div class="timeline-event"><strong>${ev.action}</strong> · ${ev.details}<div style="font-size:0.75rem;margin-top:4px;">${new Date(ev.timestamp).toLocaleTimeString('es-ES')}</div></div>`).join('')}
                </div>
            `).join('');
            timelineContent.innerHTML = html;
        }

        function getDuplicateReason(group) {
            if (group.type === 'teléfono') return 'Mismo teléfono';
            if (group.type === 'nombre') return 'Nombre coincidente';
            return 'Coincidencia múltiple';
        }

        function renderDuplicatePreview(group) {
            let result = { ...group.contacts[0] };
            for (let i = 1; i < group.contacts.length; i++) {
                result = mergeContact(result, group.contacts[i]);
            }
            return `${result.name || '-'} | ${result.phone || 'Sin teléfono'} | ${result.status || 'sin revisar'} | ${result.origin || '-'}`;
        }

        window.openWhatsApp = (phone, event) => {
            if (event) event.stopPropagation();
            if (!phone) {
                showNotification('Este contacto no tiene teléfono', 'error');
                return;
            }
            const cleanPhone = normalizePhoneNumber(phone);
            const contact = AppState.contacts.find(c => normalizePhoneNumber(c.phone) === cleanPhone);
            const message = buildWhatsAppMessage(contact?.name || '');
            const url = `https://wa.me/${cleanPhone}${message ? `?text=${encodeURIComponent(message)}` : ''}`;
            addToHistory('WhatsApp abierto', `${contact?.name || cleanPhone}`);
            saveHistory();
            window.open(url, '_blank');
        };

        window.openCardStatusMenu = (id, event) => {
            if (event) event.stopPropagation();
            const contact = AppState.contacts.find(c => c.id === id);
            const container = document.getElementById(`cardStatusInline-${id}`);
            if (!contact || !container) return;
            container.innerHTML = `<select class="card-status-select" id="statusSelect-${id}">${STATUS_OPTIONS.map(opt => `<option value="${opt.id}" ${opt.id === contact.status ? 'selected' : ''}>${opt.label}</option>`).join('')}</select>`;
            const select = document.getElementById(`statusSelect-${id}`);
            select.focus();
            const save = () => {
                const next = select.value;
                if (next !== contact.status) {
                    const old = contact.status;
                    contact.status = next;
                    contact.lastUpdated = new Date().toISOString();
                    AppState.lastEditedContact = id;
                    addToHistory('Estado cambiado', `${contact.name}: ${old} → ${next}`);
                    saveData();
                }
                render();
            };
            select.onchange = save;
            select.onblur = save;
        };

        function updateBulkActionsBar() {
            if (AppState.selectedContacts.size > 0) {
                elements.bulkActionsBar.classList.add('active');
                elements.selectedCount.textContent = AppState.selectedContacts.size;
            } else {
                elements.bulkActionsBar.classList.remove('active');
            }
        }

        function render() {
            applyFilters();
            updateStats();
            elements.pagination.style.display = 'flex';
            renderPaginatedView(AppState.currentView === 'cards' ? createCard : createListItem);
            updateBulkActionsBar();
        }

        function showDuplicatesModal() {
            const duplicates = detectDuplicates();
            
            if (duplicates.length === 0) {
                $('#duplicatesContent').innerHTML = '<p style="color: var(--accent-success); text-align: center; padding: 30px;">✅ No se encontraron duplicados</p>';
                $('#mergeAllDuplicates').style.display = 'none';
            } else {
                let html = `<div class="duplicates-list">`;
                duplicates.forEach((group, groupIndex) => {
                    html += `<div class="duplicate-group">`;
                    html += `<div class="duplicate-group-header">
                        <span>📋 ${group.name} (${group.contacts.length} entradas - ${group.type})</span><span style="font-size:0.78rem;color:var(--text-secondary);">${getDuplicateReason(group)}</span>
                    </div>`;
                    
                    group.contacts.forEach((contact, contactIndex) => {
                        const isRecommended = contactIndex === 0; // El primero es el recomendado por defecto
                        html += `<div class="duplicate-item" style="display: flex; align-items: center; justify-content: space-between; padding: 12px; ${isRecommended ? 'border: 2px solid var(--accent-primary);' : ''}">
                            <div style="flex: 1;">
                                <strong>${contact.name}</strong>
                                <div class="duplicate-item-detail">
                                    📞 ${contact.phone || 'Sin teléfono'} | 
                                    📍 ${contact.origin} | 
                                    🔵 <span class="status-badge status-${contact.status.replace(/ /g, '-')}">${contact.status}</span>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                ${isRecommended ? '<span style="color: var(--accent-primary); font-size: 0.8rem; font-weight: 600;">RECOMENDADO</span>' : ''}
                                <button class="btn" style="padding: 6px 12px; font-size: 0.8rem;" onclick="selectDuplicateToKeep(${groupIndex}, ${contactIndex})" title="Mantener este">
                                    <i class="fas fa-check"></i> Elegir
                                </button>
                            </div>
                        </div>`;
                    });
                    html += `<div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:8px;align-items:center;">
                        <button class="btn btn-success" style="padding:6px 10px;font-size:0.8rem;" onclick="combineDuplicateGroup(${groupIndex})"><i class="fas fa-object-group"></i> Combinar</button>
                        <span style="font-size:0.78rem;color:var(--text-secondary);"><strong>Preview:</strong> ${renderDuplicatePreview(group)}</span>
                    </div></div>`;
                });
                html += `</div>`;
                const totalEntries = duplicates.reduce((acc, g) => acc + g.contacts.length, 0);
                html += `<p style="color: var(--accent-warning); margin-top: 15px; text-align: center;">
                    Se encontraron ${duplicates.length} grupos duplicados con ${totalEntries} entradas totales
                </p>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 10px; text-align: center;">
                    <strong>Criterio de fusión automática:</strong> jugando > contactado > sin wsp > sin revisar > no interesado
                </p>
                <div class="duplicates-config">
                    <label><input type="radio" name="dupMergeMode" value="phone-auto" ${AppState.duplicateMergeMode === 'phone-auto' ? 'checked' : ''}> Si coincide teléfono: merge seguro. Si coincide nombre: pedir confirmación.</label>
                    <label><input type="radio" name="dupMergeMode" value="always-ask" ${AppState.duplicateMergeMode === 'always-ask' ? 'checked' : ''}> Pedir confirmación para todos los grupos.</label>
                </div>`;
                
                $('#duplicatesContent').innerHTML = html;
                $('#mergeAllDuplicates').style.display = 'block';
            }
            
            $('#duplicatesModal').classList.add('active');
        }
        
        window.selectDuplicateToKeep = (groupIndex, contactIndex) => {
            const group = AppState.duplicates[groupIndex];
            if (!group) return;
            
            const selectedContact = group.contacts[contactIndex];
            const contactsToRemove = group.contacts.filter((c, i) => i !== contactIndex);
            
            const idsToRemove = contactsToRemove.map(c => c.id);
            AppState.contacts = AppState.contacts.filter(c => !idsToRemove.includes(c.id));
            
            addToHistory('Duplicado resuelto manualmente', `${selectedContact.name} - mantenido, ${contactsToRemove.length} eliminados`);
            saveData();
            render();
            showDuplicatesModal();
            showNotification(`✅ Duplicados resueltos para ${selectedContact.name}`, 'success');
        };

        window.combineDuplicateGroup = (groupIndex) => {
            const group = AppState.duplicates[groupIndex];
            if (!group || group.contacts.length < 2) return;
            const preview = renderDuplicatePreview(group);
            const needsConfirm = AppState.duplicateMergeMode === 'always-ask' || group.type === 'nombre';
            if (needsConfirm && !confirm(`Combinar este grupo?\nResultado estimado:\n${preview}`)) return;

            let masterContact = { ...group.contacts[0] };
            for (let i = 1; i < group.contacts.length; i++) {
                masterContact = mergeContact(masterContact, group.contacts[i]);
            }
            const idsToRemove = group.contacts.map(c => c.id);
            AppState.contacts = AppState.contacts.filter(c => !idsToRemove.includes(c.id));
            AppState.contacts.push(masterContact);
            addToHistory('Duplicado combinado', `${group.name} -> ${masterContact.name}`);
            saveData();
            render();
            showDuplicatesModal();
            showNotification('Grupo combinado correctamente', 'success');
        };

        function mergeAllDuplicates() {
            const duplicates = AppState.duplicates;
            let mergedCount = 0;
            
            duplicates.forEach(group => {
                if (group.contacts.length > 1) {
                    const needsConfirm = AppState.duplicateMergeMode === 'always-ask' || (AppState.duplicateMergeMode === 'phone-auto' && group.type === 'nombre');
                    if (needsConfirm && !confirm(`Confirmar fusión para grupo: ${group.name}`)) return;
                    let masterContact = { ...group.contacts[0] };
                    
                    for (let i = 1; i < group.contacts.length; i++) {
                        masterContact = mergeContact(masterContact, group.contacts[i]);
                    }
                    
                    const idsToRemove = group.contacts.map(c => c.id);
                    AppState.contacts = AppState.contacts.filter(c => !idsToRemove.includes(c.id));
                    AppState.contacts.push(masterContact);
                    
                    mergedCount += group.contacts.length - 1;
                }
            });
            
            addToHistory('Duplicados fusionados', `${mergedCount} duplicados fusionados`);
            saveData();
            render();
            $('#duplicatesModal').classList.remove('active');
            showNotification(`✅ ${mergedCount} duplicados fusionados`, 'success');
        }

        function showHistoryModal() {
            const historyHTML = AppState.history.length > 0 
                ? AppState.history.map(entry => {
                    const nameMatch = entry.details.match(/^([^:]+)/);
                    const userName = nameMatch ? nameMatch[1].trim() : '';
                    
                    return `
                    <div class="history-item" onclick="searchFromHistory('${userName.replace(/'/g, "\\'")}', event)" style="cursor: pointer;" title="Click para buscar este contacto">
                        <div class="history-time">${new Date(entry.timestamp).toLocaleString('es-ES')}</div>
                        <div class="history-action"><strong>${entry.action}:</strong> ${entry.details}</div>
                    </div>
                `}).join('')
                : '<p style="text-align: center; color: var(--text-secondary); padding: 30px;">No hay historial disponible</p>';
            
            $('#historyList').innerHTML = historyHTML;
            $('#historyModal').classList.add('active');
        }
        
        window.searchFromHistory = (name, event) => {
            if (event) event.stopPropagation();
            elements.searchInput.value = name;
            AppState.searchTerm = name;
            $('#historyModal').classList.remove('active');
            render();
            showNotification(`🔍 Buscando: ${name}`, 'info');
        };

        function setupEventListeners() {
            elements.uploadArea.onclick = () => elements.fileInput.click();
            elements.uploadArea.ondragover = (e) => { e.preventDefault(); elements.uploadArea.style.borderColor = 'var(--accent-primary)'; };
            elements.uploadArea.ondragleave = () => elements.uploadArea.style.borderColor = 'var(--border-color)';
            elements.uploadArea.ondrop = (e) => {
                e.preventDefault();
                elements.uploadArea.style.borderColor = 'var(--border-color)';
                const files = Array.from(e.dataTransfer.files).filter(f => f.name.endsWith('.csv') || f.name.endsWith('.vcf'));
                if (files.length > 0) {
                    selectedFiles.push(...files);
                    updateFileList();
                }
            };

            elements.fileInput.onchange = (e) => {
                selectedFiles = Array.from(e.target.files);
                updateFileList();
            };

            elements.startBtn.onclick = loadFiles;

            elements.addMoreBtn.onclick = () => {
                elements.importOptionsModal.classList.add('active');
            };
            $('#openImportFilesOption').onclick = () => {
                elements.importOptionsModal.classList.remove('active');
                elements.uploadScreen.classList.remove('hidden');
                elements.fileInput.value = '';
                selectedFiles = [];
                elements.fileList.innerHTML = '';
                elements.startBtn.disabled = true;
            };
            $('#openWhatsappMessageOption').onclick = () => {
                elements.importOptionsModal.classList.remove('active');
                elements.whatsappMessageModal.classList.add('active');
                elements.whatsappTemplateInput.value = AppState.whatsappTemplate;
            };
            $('#closeImportOptionsModal').onclick = () => elements.importOptionsModal.classList.remove('active');

            elements.searchInput.oninput = (e) => {
                AppState.searchTerm = e.target.value;
                AppState.currentPage = 1;
                render();
            };

            $('#undoBtn').onclick = undoToLastContact;
            
            elements.saveTemplateBtn.onclick = () => {
                AppState.whatsappTemplate = elements.whatsappTemplateInput.value;
                savePreferences();
                showNotification('Mensaje de WhatsApp guardado', 'success');
                elements.whatsappMessageModal.classList.remove('active');
            };
            elements.insertUserTokenBtn.onclick = () => {
                const el = elements.whatsappTemplateInput;
                const token = '{usuario}';
                const start = el.selectionStart || el.value.length;
                const end = el.selectionEnd || el.value.length;
                el.value = el.value.slice(0, start) + token + el.value.slice(end);
                el.focus();
                el.selectionStart = el.selectionEnd = start + token.length;
            };
            elements.resetTemplateBtn.onclick = () => {
                elements.whatsappTemplateInput.value = 'Hola {usuario}, ¿cómo estás? Te escribo por la propuesta que vimos.';
                AppState.whatsappTemplate = elements.whatsappTemplateInput.value;
                savePreferences();
            };
            elements.shortcutsInfoBtn.onclick = () => elements.shortcutsModal.classList.add('active');
            $('#closeWhatsappMessageModal').onclick = () => elements.whatsappMessageModal.classList.remove('active');
            const closeShortcutsBtn = $('#closeShortcutsModal');
            if (closeShortcutsBtn) closeShortcutsBtn.onclick = () => elements.shortcutsModal.classList.remove('active');

            document.addEventListener('change', (e) => {
                if (e.target && e.target.name === 'dupMergeMode') {
                    AppState.duplicateMergeMode = e.target.value;
                    savePreferences();
                }
            });

            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'z' && !e.target.matches('input, textarea')) {
                    e.preventDefault();
                    undoToLastContact();
                    return;
                }
                if (e.target.matches('input, textarea, select')) return;
                const code = e.code;
                const selectedId = Array.from(AppState.selectedContacts)[0] || AppState.lastEditedContact;
                if (code === 'Numpad1' && selectedId) changeContactStatus(selectedId, 'sin revisar');
                else if (code === 'Numpad2' && selectedId) changeContactStatus(selectedId, 'contactado');
                else if (code === 'Numpad3' && selectedId) changeContactStatus(selectedId, 'jugando');
                else if (code === 'Numpad4' && selectedId) changeContactStatus(selectedId, 'sin wsp');
                else if (code === 'Numpad5' && selectedId) changeContactStatus(selectedId, 'no interesado');
                else if (code === 'Numpad0') undoToLastContact();
                else if (code === 'NumpadAdd') elements.viewListBtn.click();
                else if (code === 'NumpadSubtract') elements.timelineBtn.click();
            });

            elements.statusFilter.onchange = (e) => {
                AppState.statusFilter = e.target.value;
                AppState.currentPage = 1;
                render();
            };

            elements.originFilter.onchange = (e) => {
                AppState.originFilter = e.target.value;
                AppState.currentPage = 1;
                render();
            };

            elements.viewCardsBtn.onclick = () => {
                AppState.currentView = 'cards';
                elements.viewCardsBtn.classList.add('active');
                elements.viewListBtn.classList.remove('active');
                elements.cardsView.style.display = 'grid';
                elements.listView.style.display = 'none';
                render();
            };

            elements.viewListBtn.onclick = () => {
                AppState.currentView = 'list';
                elements.viewListBtn.classList.add('active');
                elements.viewCardsBtn.classList.remove('active');
                elements.listView.style.display = 'block';
                elements.cardsView.style.display = 'none';
                render();
            };
            elements.timelineBtn.onclick = () => {
                createTimelineView();
                $('#timelineModal').classList.add('active');
            };

            $$('.stat-box').forEach(box => {
                box.onclick = () => {
                    const filter = box.dataset.filter;
                    if (box === elements.duplicatesStatBox) {
                        showDuplicatesModal();
                        return;
                    }
                    
                    $$('.stat-box').forEach(b => b.classList.remove('active'));
                    if (AppState.statusFilter === filter) {
                        AppState.statusFilter = '';
                    } else {
                        AppState.statusFilter = filter;
                        box.classList.add('active');
                    }
                    elements.statusFilter.value = AppState.statusFilter;
                    render();
                };
            });

            const unifiedEventHandler = (e) => {
                const card = e.target.closest('.contact-card, .list-item');
                if (!card) return;
                
                const id = parseFloat(card.dataset.id);
                if (isNaN(id)) return;

                const isCheckbox = e.target.matches('input[type="checkbox"]');
                const isButton = e.target.closest('button');
                
                if (isButton && !e.target.closest('.list-item-name, .list-item-phone')) return;
                
                if (isCheckbox) {
                     if (e.target.checked) AppState.selectedContacts.add(id);
                     else AppState.selectedContacts.delete(id);
                } else {
                     if (AppState.selectedContacts.has(id)) {
                        AppState.selectedContacts.delete(id);
                    } else {
                        AppState.selectedContacts.add(id);
                    }
                }
                
                updateBulkActionsBar();
                elements.pagination.style.display = 'flex';
                renderPaginatedView(AppState.currentView === 'cards' ? createCard : createListItem);
            };

            const unifiedDblClickHandler = (e) => {
                const target = e.target.closest('[data-field]');
                if (!target) return;
                
                const card = e.target.closest('.contact-card, .list-item');
                const id = parseFloat(card.dataset.id);
                const field = target.dataset.field;
                const contact = AppState.contacts.find(c => c.id === id);
                
                if (!contact) return;
                
                const originalValue = target.textContent.trim();
                let hasSaved = false;

                if (field === 'status') {
                    const select = document.createElement('select');
                    select.className = 'filter-select';
                    select.style.width = '100%';
                    select.innerHTML = STATUS_OPTIONS.map(opt => 
                        `<option value="${opt.id}" ${opt.id === contact.status ? 'selected' : ''}>${opt.label}</option>`
                    ).join('');
                    target.textContent = '';
                    target.appendChild(select);
                    select.focus();
                    
                    const save = () => {
                        if (hasSaved) return;
                        hasSaved = true;
                        const oldStatus = contact.status;
                        contact.status = select.value;
                        contact.lastUpdated = new Date().toISOString();
                        addToHistory('Estado cambiado', `${contact.name}: ${oldStatus} → ${select.value}`);
                        saveData();
                        render();
                    };
                    
                    select.onblur = save;
                    select.onchange = save;
                }
            };
            
            $$('#cardsView, #listView').forEach(el => {
                el.addEventListener('click', unifiedEventHandler);
                el.addEventListener('dblclick', unifiedDblClickHandler);
            });

            $('#bulkDeleteBtn').onclick = () => {
                if(AppState.selectedContacts.size > 0 && confirm(`¿Eliminar ${AppState.selectedContacts.size} contactos seleccionados?`)) {
                    const selectedCount = AppState.selectedContacts.size;
                    AppState.contacts = AppState.contacts.filter(c => !AppState.selectedContacts.has(c.id));
                    AppState.selectedContacts.clear();
                    addToHistory('Eliminación masiva', `${selectedCount} contactos eliminados`);
                    saveData();
                    render();
                    showNotification(`${selectedCount} contactos eliminados.`, 'success');
                }
            };

            $('#bulkStatusSelect').onchange = (e) => {
                const newStatus = e.target.value;
                if (AppState.selectedContacts.size > 0 && newStatus) {
                   const selectedCount = AppState.selectedContacts.size;
                   AppState.selectedContacts.forEach(id => {
                        const contact = AppState.contacts.find(c => c.id === id);
                        if (contact) {
                            contact.status = newStatus;
                            contact.lastUpdated = new Date().toISOString();
                        }
                   });
                   addToHistory('Cambio de estado masivo', `${selectedCount} contactos → ${newStatus}`);
                   AppState.selectedContacts.clear();
                   saveData();
                   render();
                   showNotification(`${selectedCount} contactos actualizados.`, 'success');
                   e.target.value = "";
                }
            };

            $('#bulkCancelBtn').onclick = () => {
                AppState.selectedContacts.clear();
                render();
            };

            $('#exportBtn').onclick = () => {
                $('#exportFilteredCount').textContent = `${AppState.filteredContacts.length} contactos`;
                $('#exportAllCount').textContent = `${AppState.contacts.length} contactos`;
                $('#exportModal').classList.add('active');
            };

            $('#cancelExport').onclick = () => $('#exportModal').classList.remove('active');

            $('#confirmExport').onclick = () => {
                const type = $('#exportModal .export-option[data-type].selected').dataset.type;
                const format = $('#exportModal .export-option[data-format].selected').dataset.format;
                const contactsToExport = type === 'all' ? AppState.contacts : AppState.filteredContacts;
                
                if (format === 'excel') exportToExcel(contactsToExport);
                else if (format === 'vcf') exportToVCF(contactsToExport);
                else if (format === 'sheet') exportToSheetFormat(AppState.contacts);

                $('#exportModal').classList.remove('active');
            };

            $$('#exportModal .export-option').forEach(opt => opt.onclick = (e) => {
                const option = e.target.closest('.export-option');
                const group = option.dataset.type ? '[data-type]' : '[data-format]';
                $$(`#exportModal .export-option${group}`).forEach(o => o.classList.remove('selected'));
                option.classList.add('selected');
            });

            elements.manageDuplicatesBtn.onclick = showDuplicatesModal;
            $('#closeDuplicatesModal').onclick = () => $('#duplicatesModal').classList.remove('active');
            $('#mergeAllDuplicates').onclick = () => {
                if (confirm('¿Fusionar todos los duplicados? Esta acción no se puede deshacer.')) {
                    mergeAllDuplicates();
                }
            };

            elements.historyBtn.onclick = showHistoryModal;
            $('#closeHistoryModal').onclick = () => $('#historyModal').classList.remove('active');
            $('#closeTimelineModal').onclick = () => $('#timelineModal').classList.remove('active');
            $('#clearHistoryBtn').onclick = () => {
                if (confirm('¿Borrar todo el historial?')) {
                    AppState.history = [];
                    saveHistory();
                    $('#historyModal').classList.remove('active');
                    showNotification('Historial borrado', 'success');
                }
            };

            $('#addSingleBtn').onclick = () => {
                $('#singleName').value = '';
                $('#singlePhone').value = '';
                $('#singleOrigin').value = '';
                $('#singleStatus').value = 'sin revisar';
                $('#addSingleModal').classList.add('active');
            };

            $('#cancelAddSingle').onclick = () => $('#addSingleModal').classList.remove('active');

            $('#confirmAddSingle').onclick = () => {
                const name = $('#singleName').value.trim();
                const phone = normalizePhoneNumber($('#singlePhone').value.trim());
                const origin = $('#singleOrigin').value.trim() || 'Manual';
                const status = $('#singleStatus').value;

                if (!name) {
                    showNotification('El nombre es obligatorio', 'error');
                    return;
                }

                const newContact = {
                    id: Date.now() + Math.random(),
                    name: name,
                    phone: phone,
                    origin: origin,
                    status: status,
                    lastUpdated: new Date().toISOString(),
                    isDuplicate: false
                };

                AppState.contacts.push(newContact);
                addToHistory('Contacto agregado manualmente', name);
                detectDuplicates();
                saveData();
                render();
                $('#addSingleModal').classList.remove('active');
                showNotification('✅ Contacto agregado', 'success');
            };

            $('#deleteAllBtn').onclick = () => {
                if (confirm('⚠️ ¿BORRAR TODOS LOS CONTACTOS? Esta acción NO se puede deshacer.')) {
                    const count = AppState.contacts.length;
                    AppState.contacts = [];
                    AppState.selectedContacts.clear();
                    addToHistory('Todos los contactos eliminados', `${count} contactos borrados`);
                    saveData();
                    render();
                    showNotification(`${count} contactos eliminados`, 'success');
                }
            };
        }

        function updateFileList() {
            if (selectedFiles.length === 0) {
                elements.fileList.innerHTML = '';
                elements.startBtn.disabled = true;
                return;
            }
            
            elements.fileList.innerHTML = selectedFiles.map((f, i) => 
                `<div class="file-item">
                    <span><i class="fas fa-file-csv"></i> ${f.name}</span>
                    <span>${(f.size / 1024).toFixed(1)} KB</span>
                </div>`
            ).join('');
            
            elements.startBtn.disabled = false;
        }

        function formatCsvField(value) {
            if (value === null || value === undefined) return '""';
            const stringValue = String(value);
            if (stringValue.includes(',') || stringValue.includes('\n') || stringValue.includes('"')) {
                return `"${stringValue.replace(/"/g, '""')}"`;
            }
            return `"${stringValue}"`;
        }
        
        function exportToExcel(contacts) {
            let csvContent = "Nombre,Teléfono,Origen,Estado,Fecha Actualización\n";
            contacts.forEach(c => {
                const row = [
                    formatCsvField(c.name),
                    formatCsvField(c.phone),
                    formatCsvField(c.origin),
                    formatCsvField(c.status),
                    formatCsvField(new Date(c.lastUpdated).toLocaleDateString('es-ES'))
                ];
                csvContent += row.join(',') + '\n';
            });
            downloadFile(csvContent, `contactos_${new Date().toISOString().split('T')[0]}.csv`, 'text/csv;charset=utf-8;');
            showNotification('Exportación a Excel completada', 'success');
        }

        function exportToVCF(contacts) {
            let vcfContent = '';
            contacts.forEach(c => {
                vcfContent += `BEGIN:VCARD\n`;
                vcfContent += `VERSION:3.0\n`;
                vcfContent += `FN:${c.name}\n`;
                if (c.phone) {
                    vcfContent += `TEL;TYPE=CELL:${c.phone}\n`;
                }
                vcfContent += `NOTE:Origen: ${c.origin}, Estado: ${c.status}\n`;
                vcfContent += `END:VCARD\n\n`;
            });
            downloadFile(vcfContent, `contactos_${new Date().toISOString().split('T')[0]}.vcf`, 'text/vcard;charset=utf-8');
            showNotification('✅ Exportación a VCF completada', 'success');
        }
        
        function parseVCF(text) {
            const contacts = [];
            const vcards = text.split('BEGIN:VCARD').filter(v => v.trim());
            
            vcards.forEach(vcard => {
                const contact = {};
                const lines = vcard.split('\n').map(l => l.trim()).filter(Boolean);
                
                lines.forEach(line => {
                    if (line.startsWith('FN:')) {
                        contact.name = line.substring(3).trim();
                    } else if (line.startsWith('TEL')) {
                        const phoneMatch = line.match(/:([\d+]+)/);
                        if (phoneMatch) {
                            contact.phone = normalizePhoneNumber(phoneMatch[1]);
                        }
                    } else if (line.startsWith('NOTE:')) {
                        const noteText = line.substring(5);
                        
                        const origenMatch = noteText.match(/Origen:\s*([^,]+)/);
                        if (origenMatch) {
                            contact.origin = origenMatch[1].trim();
                        }
                        
                        const estadoMatch = noteText.match(/Estado:\s*(.+)/);
                        if (estadoMatch) {
                            const estado = estadoMatch[1].trim().toLowerCase();
                            if (estado.includes('contactado')) contact.status = 'contactado';
                            else if (estado.includes('jugando')) contact.status = 'jugando';
                            else if (estado.includes('sin wsp')) contact.status = 'sin wsp';
                            else if (estado.includes('no interesado')) contact.status = 'no interesado';
                            else contact.status = 'sin revisar';
                        }
                    }
                });
                
                if (contact.name) {
                    if (!contact.status) contact.status = 'sin revisar';
                    if (!contact.origin) contact.origin = 'VCF Importado';
                    if (!contact.phone) contact.phone = '';
                    contacts.push(contact);
                }
            });
            
            return contacts;
        }

        function exportToSheetFormat(contacts) {
            const headers = "usuarios,estado de revision,telefono,estado actual,\"VISTO, RESPONDIDO?\",RECUPERADO,TURNO DE LAS CARGAS,interesado en jugar?,ya contactados,recuperados!,actualmente cargando,TURNO MAÑANA,TURNO TARDE,TURNO NOCHE,contactos a borrar\n";
            
            const statusToSheetStatus = (status) => {
                const map = { 'contactado': 'promo enviada', 'sin wsp': 'NO ESTA EN WSP', 'sin revisar': 'A CONTACTAR', 'jugando': 'EN CONTACTO', 'no interesado': 'ELIMINADO' };
                return map[status] || 'SIN REVISAR';
            };

            const yaContactados = contacts.filter(c => c.status === 'contactado').map(c => c.name);
            const recuperados = contacts.filter(c => c.status === 'jugando').map(c => c.name);
            const actualmenteCargando = contacts.filter(c => c.origin && c.origin.toLowerCase().includes('cargando')).map(c => c.name);
            const turnoManana = contacts.filter(c => c.origin && c.origin.toLowerCase().includes('mañana')).map(c => c.name);
            const turnoTarde = contacts.filter(c => c.origin && c.origin.toLowerCase().includes('tarde')).map(c => c.name);
            const turnoNoche = contacts.filter(c => c.origin && c.origin.toLowerCase().includes('noche')).map(c => c.name);
            const aBorrar = contacts.filter(c => c.status === 'no interesado').map(c => c.name);

            const maxLength = Math.max(contacts.length, yaContactados.length, recuperados.length, actualmenteCargando.length, turnoManana.length, turnoTarde.length, turnoNoche.length, aBorrar.length);
            
            let csvContent = headers;

            for (let i = 0; i < maxLength; i++) {
                const mainContact = contacts[i];
                const row = [
                    mainContact ? formatCsvField(mainContact.name) : '',
                    mainContact ? formatCsvField(statusToSheetStatus(mainContact.status)) : '',
                    mainContact && mainContact.phone ? formatCsvField(mainContact.phone) : '',
                    mainContact ? formatCsvField(statusToSheetStatus(mainContact.status)) : '',
                    'NO', 'NO', '', 'NO',
                    formatCsvField(yaContactados[i]),
                    formatCsvField(recuperados[i]),
                    formatCsvField(actualmenteCargando[i]),
                    formatCsvField(turnoManana[i]),
                    formatCsvField(turnoTarde[i]),
                    formatCsvField(turnoNoche[i]),
                    formatCsvField(aBorrar[i])
                ];
                csvContent += row.join(',') + '\n';
            }

            downloadFile(csvContent, `planilla_exportada_${new Date().toISOString().split('T')[0]}.csv`, 'text/csv;charset=utf-8;');
            showNotification('Exportación completada con teléfonos', 'success');
        }

        function downloadFile(content, fileName, mimeType) {
            const bom = mimeType.includes('csv') ? '\uFEFF' : '';
            const blob = new Blob([bom + content], { type: mimeType });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function init() {
            try {
                elements.bulkStatusSelect.innerHTML = `<option value="" disabled selected>Cambiar estado</option>` + STATUS_OPTIONS.map(opt => `<option value="${opt.id}">${opt.label}</option>`).join('');
                setupEventListeners();
                loadHistory();
                loadPreferences();
                loadData();
            } catch (e) {
                console.error("Error fatal en la inicialización:", e);
                document.body.innerHTML = "<h1>Error Crítico</h1><p>La aplicación no pudo iniciarse. Por favor, borra la caché y los datos del sitio e inténtalo de nuevo.</p>";
            }
        }

        init();
    })();
    </script>


</body></html>
