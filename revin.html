<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dif • Análisis de Retención</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap');
      
      body {
        font-family: 'Inter', sans-serif;
        background-color: #111418;
        color: white;
      }
      
      /* Custom Scrollbar for dark theme */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #1A1E23; 
      }
      ::-webkit-scrollbar-thumb {
        background: #2A2F36; 
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #3A4048; 
      }

      /* Animation utilities */
      .animate-fade-in { animation: fadeIn 0.6s ease-out; }
      .animate-slide-up { animation: slideInUp 0.4s ease-out; }
      
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
      @keyframes slideInUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
    </style>
    
    <script type="importmap">
    {
      "imports": {
        "react": "https://aistudiocdn.com/react@^19.2.0",
        "react-dom/client": "https://aistudiocdn.com/react-dom@^19.2.0/client",
        "lucide-react": "https://aistudiocdn.com/lucide-react@^0.555.0"
      }
    }
    </script>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
      import React, { useState, useMemo } from 'react';
      import { createRoot } from 'react-dom/client';
      import { 
        Users, ArrowRight, Upload, Filter, Copy, ArrowDownUp, AlertTriangle, CheckCircle 
      } from 'lucide-react';

      /* --- UTILS --- */
      
      const parseCSVLine = (line) => {
        const result = [];
        let cur = '';
        let inQuotes = false;
        for (let i = 0; i < line.length; i++) {
          const ch = line[i];
          if (ch === '"') {
            if (inQuotes && line[i+1] === '"') { cur += '"'; i++; }
            else inQuotes = !inQuotes;
            continue;
          }
          if (ch === ',' && !inQuotes) { result.push(cur); cur = ''; continue; }
          cur += ch;
        }
        result.push(cur);
        return result;
      };

      const cleanMonto = (val) => {
        let s = String(val !== undefined ? val : '').replace(/\s+/g,'').replace(/[^0-9\.\-]/g,'');
        return parseFloat(s) || 0;
      };

      const parseDate = (str) => {
        if(!str) return null;
        const d = new Date(str.replace(' ', 'T'));
        return isNaN(d.getTime()) ? new Date(str) : d;
      };

      /* Parser 'mastr': Fecha(0), Cantidad(3), Alias(6 o 5) */
      const parseRowsmastr = (lines) => {
        return lines.map(line => {
          if (!line || !line.trim()) return null;
          const cols = parseCSVLine(line);
          const fecha = (cols[0]||'').trim();
          const monto = cleanMonto(cols[3]);
          let usuario = (cols[6] || cols[5] || '').trim().toLowerCase();
          return { fecha, fechaObj: parseDate(fecha), monto, usuario };
        }).filter(r => r && r.usuario);
      };

      /* Parser 'agente': Fecha(0), Cantidad(2), Alias(4 o 3) */
      const parseRowsagente = (lines) => {
        return lines.map(line => {
          if (!line || !line.trim()) return null;
          const cols = parseCSVLine(line);
          const fecha = (cols[0]||'').trim();
          const monto = cleanMonto(cols[2]);
          let usuario = (cols[4] || cols[3] || '').trim().toLowerCase();
          return { fecha, fechaObj: parseDate(fecha), monto, usuario };
        }).filter(r => r && r.usuario);
      };

      const readFile = (file) => {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = e => {
             const text = String(e.target.result || '');
             // Remove BOM and split
             const lines = text.replace(/^\uFEFF/, '').split(/\r?\n/).filter(l => l.trim() !== '');
             // Skip header heuristic
             const content = (lines.length > 0 && /[Ff]echa|[Tt]ipo|Alias|Cantidad/.test(lines[0])) 
               ? lines.slice(1) 
               : lines;
             resolve(content);
          };
          reader.onerror = reject;
          reader.readAsText(file);
        });
      };

      const formatCurrency = (val) => val.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

      /* --- COMPONENTS --- */

      const StatCard = ({ label, value, subtext, type = 'neutral' }) => {
        let color = "text-white";
        if (type === 'good') color = "text-[#9EE759]";
        if (type === 'bad') color = "text-[#EF4444]";
        
        return (
          <div className="bg-[#1E2329] border border-[#2A2A2A] rounded-xl p-4 flex flex-col justify-between h-full">
             <span className="text-xs text-[#A8A8A8] uppercase font-bold tracking-wider">{label}</span>
             <div className="mt-2">
               <div className={`text-2xl font-bold ${color}`}>{value}</div>
               {subtext && <div className="text-xs text-[#555] mt-1">{subtext}</div>}
             </div>
          </div>
        );
      };

      const ResultTable = ({ title, users, onCopy, badgeColor }) => {
        if (!users || users.length === 0) return null;

        return (
          <div className="bg-[#1E2329] border border-[#2A2A2A] rounded-xl overflow-hidden mb-6 animate-slide-up">
            <div className="p-4 border-b border-[#2A2A2A] flex justify-between items-center bg-[#242930]/50">
              <div className="flex items-center gap-3">
                 <div className={`w-3 h-3 rounded-full ${badgeColor}`}></div>
                 <h3 className="font-bold text-white text-lg">{title}</h3>
                 <span className="text-xs text-[#777] font-mono bg-[#1A1E23] px-2 py-1 rounded border border-[#2A2A2A]">
                   {users.length} usuarios
                 </span>
              </div>
              <button 
                onClick={onCopy}
                className="flex items-center gap-2 text-xs font-bold bg-[#2A2F36] hover:bg-[#3A4048] text-[#EAF2FF] px-3 py-1.5 rounded-lg transition-colors border border-[#333]"
              >
                <Copy size={14} /> Copiar lista
              </button>
            </div>
            
            <div className="max-h-[300px] overflow-y-auto custom-scrollbar">
              <table className="w-full text-sm text-left">
                <thead className="sticky top-0 bg-[#1A1E23] text-[#777] text-xs uppercase font-semibold">
                  <tr>
                    <th className="p-3 pl-6">Fecha (Última)</th>
                    <th className="p-3">Usuario</th>
                    <th className="p-3 text-right">Apariciones (Mes Prev)</th>
                    <th className="p-3 pr-6 text-right">Monto Total (Mes Prev)</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-[#2A2A2A]">
                  {users.map((u, i) => (
                    <tr key={i} className="hover:bg-[#24364A]/10 transition-colors">
                      <td className="p-3 pl-6 text-[#AAA] font-mono text-xs">{u.fecha}</td>
                      <td className="p-3 font-medium text-white">{u.usuario}</td>
                      <td className="p-3 text-right text-[#AAA]">{u.apariciones}</td>
                      <td className="p-3 pr-6 text-right font-mono text-[#9EE759] font-bold">
                        $ {formatCurrency(u.monto)}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        );
      };

      /* --- MAIN APP --- */

      function App() {
        // State
        const [filePrev, setFilePrev] = useState(null);
        const [fileCurr, setFileCurr] = useState(null);
        const [originMode, setOriginMode] = useState(0); // 0 = mastr, 1 = agente
        const [sortMode, setSortMode] = useState('monto'); // 'monto' | 'operaciones'
        
        // Settings
        const [onlySingle, setOnlySingle] = useState(false);
        const [maxRows, setMaxRows] = useState(0);

        // Results
        const [stats, setStats] = useState(null);
        const [results, setResults] = useState(null); // { TM: [], TT: [], TN: [] }
        const [isProcessing, setIsProcessing] = useState(false);

        const handleProcess = async () => {
          if (!filePrev || !fileCurr) return alert("Por favor carga ambos archivos (Mes Anterior y Mes Actual).");
          setIsProcessing(true);

          try {
            // 1. Read files
            const linesPrev = await readFile(filePrev);
            const linesCurr = await readFile(fileCurr);

            // 2. Parse
            const parser = originMode === 0 ? parseRowsmastr : parseRowsagente;
            const prevData = parser(linesPrev);
            const currData = parser(linesCurr);

            // 3. Analyze
            // Set of active users in current month
            const currentUsersSet = new Set(currData.map(r => r.usuario));
            
            // Group previous month by user to get totals
            const prevMap = {};
            prevData.forEach(r => {
               if(!prevMap[r.usuario]) {
                 prevMap[r.usuario] = { 
                   usuario: r.usuario, 
                   totalMonto: 0, 
                   count: 0, 
                   lastFecha: r.fecha, 
                   lastFechaObj: r.fechaObj 
                 };
               }
               prevMap[r.usuario].totalMonto += r.monto;
               prevMap[r.usuario].count += 1;
               
               // Keep most recent date
               const tCur = r.fechaObj?.getTime() || 0;
               const tStored = prevMap[r.usuario].lastFechaObj?.getTime() || 0;
               if(tCur > tStored) {
                 prevMap[r.usuario].lastFecha = r.fecha;
                 prevMap[r.usuario].lastFechaObj = r.fechaObj;
               }
            });

            // 4. Find Dropped
            let dropped = Object.values(prevMap).filter(u => !currentUsersSet.has(u.usuario));
            
            // 5. Apply "Single" Filter (Users who only appeared once in prev month)
            if (onlySingle) {
              dropped = dropped.filter(u => u.count === 1);
            }

            // 6. Stats
            const totalMontoPrev = prevData.reduce((acc, r) => acc + r.monto, 0);
            const droppedMonto = dropped.reduce((acc, u) => acc + u.totalMonto, 0);

            // 7. Group by Turno
            const turnos = { TM: [], TT: [], TN: [] };
            dropped.forEach(u => {
              let h = 22; // Default TN
              if(u.lastFechaObj) h = u.lastFechaObj.getHours();
              else if(u.lastFecha) {
                 const m = u.lastFecha.match(/(\d{2}):(\d{2}):/);
                 if(m) h = parseInt(m[1], 10);
              }

              if(h >= 6 && h < 14) turnos.TM.push(u);
              else if(h >= 14 && h < 22) turnos.TT.push(u);
              else turnos.TN.push(u);
            });

            // 8. Sorting
            const sorter = (a, b) => sortMode === 'monto' 
                ? b.totalMonto - a.totalMonto 
                : b.count - a.count;
            
            Object.keys(turnos).forEach(k => turnos[k].sort(sorter));

            // 9. Max Rows Limiting
            const finalResults = {};
            const limit = maxRows > 0 ? maxRows : Infinity;
            Object.keys(turnos).forEach(k => {
              finalResults[k] = turnos[k].slice(0, limit);
            });

            setStats({
              totalPrev: prevData.length,
              totalPrevMonto: totalMontoPrev,
              uniquePrev: Object.keys(prevMap).length,
              droppedCount: dropped.length,
              droppedMonto: droppedMonto
            });
            setResults(finalResults);

          } catch (e) {
            console.error(e);
            alert("Error procesando archivos: " + e.message);
          } finally {
            setIsProcessing(false);
          }
        };

        // Recalculate sorting if results exist and user toggles sort
        const handleSortChange = () => {
           const newMode = sortMode === 'monto' ? 'operaciones' : 'monto';
           setSortMode(newMode);
           if (results) {
             // Re-sort existing
             const sorter = (a, b) => newMode === 'monto' 
                ? b.totalMonto - a.totalMonto 
                : b.count - a.count;
             
             const newResults = { ...results };
             Object.keys(newResults).forEach(k => newResults[k].sort(sorter));
             setResults(newResults);
           }
        };

        const copyTurno = (list) => {
          const text = list.map(u => `- ${u.usuario}`).join('\n');
          navigator.clipboard.writeText(text).then(() => alert("Copiado al portapapeles"));
        };

        return (
          <div className="min-h-screen p-4 md:p-8 max-w-5xl mx-auto animate-fade-in pb-24">
            
            {/* Header */}
            <div className="flex items-center gap-3 mb-8 animate-slide-up">
              <div className="p-3 bg-gradient-to-br from-[#C7F24A] to-[#24364A] rounded-xl text-black shadow-lg shadow-[#C7F24A]/20">
                <Users size={24} />
              </div>
              <div>
                <h1 className="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-[#A8A8A8]">
                  Dif • Análisis de Retención
                </h1>
                <p className="text-sm text-[#777]">Detecta usuarios que cargaron el mes anterior pero no el actual.</p>
              </div>
            </div>

            {/* Input Card */}
            <div className="bg-[#1A1E23] border border-[#2A2A2A] rounded-xl p-6 shadow-2xl mb-8 animate-slide-up">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                
                {/* File Inputs */}
                <div className="space-y-4">
                  <div>
                    <label className="text-xs font-bold text-[#A8A8A8] uppercase mb-2 block flex items-center gap-2">
                       <div className="w-2 h-2 rounded-full bg-[#7A5CFF]"></div> Mes Anterior (CSV)
                    </label>
                    <input 
                      type="file" 
                      accept=".csv"
                      onChange={e => setFilePrev(e.target.files[0])}
                      className="w-full bg-[#1E2329] border border-[#2A2A2A] rounded-lg p-3 text-sm text-[#CCC] file:bg-[#2A2F36] file:text-white file:border-0 file:rounded file:px-3 file:py-1 file:text-xs file:font-bold hover:border-[#7A5CFF] transition-colors"
                    />
                  </div>
                  <div className="flex justify-center text-[#555]">
                    <ArrowDownUp size={16} />
                  </div>
                  <div>
                    <label className="text-xs font-bold text-[#A8A8A8] uppercase mb-2 block flex items-center gap-2">
                      <div className="w-2 h-2 rounded-full bg-[#9EE759]"></div> Mes Actual (CSV)
                    </label>
                    <input 
                      type="file" 
                      accept=".csv"
                      onChange={e => setFileCurr(e.target.files[0])}
                      className="w-full bg-[#1E2329] border border-[#2A2A2A] rounded-lg p-3 text-sm text-[#CCC] file:bg-[#2A2F36] file:text-white file:border-0 file:rounded file:px-3 file:py-1 file:text-xs file:font-bold hover:border-[#9EE759] transition-colors"
                    />
                  </div>
                </div>

                {/* Controls */}
                <div className="flex flex-col gap-4 justify-center bg-[#1E2329]/50 p-4 rounded-xl border border-[#2A2A2A]/50">
                  
                  {/* Format Toggle */}
                  <div>
                    <label className="text-xs font-bold text-[#777] uppercase mb-2 block">Formato CSV</label>
                    <div className="flex bg-[#111418] p-1 rounded-lg border border-[#2A2A2A]">
                       <button 
                         onClick={() => setOriginMode(0)}
                         className={`flex-1 py-2 text-xs font-bold rounded-md transition-all ${originMode === 0 ? 'bg-[#24364A] text-white shadow' : 'text-[#555] hover:text-[#CCC]'}`}
                       >
                         MASTR
                       </button>
                       <button 
                         onClick={() => setOriginMode(1)}
                         className={`flex-1 py-2 text-xs font-bold rounded-md transition-all ${originMode === 1 ? 'bg-[#24364A] text-white shadow' : 'text-[#555] hover:text-[#CCC]'}`}
                       >
                         AGENTE
                       </button>
                    </div>
                  </div>

                  {/* Options */}
                  <div className="flex flex-col gap-3">
                    <label className="flex items-center gap-2 cursor-pointer group">
                      <div className={`w-5 h-5 rounded border flex items-center justify-center transition-colors ${onlySingle ? 'bg-[#C7F24A] border-[#C7F24A]' : 'bg-[#1A1E23] border-[#333]'}`}>
                        <input type="checkbox" className="hidden" checked={onlySingle} onChange={e => setOnlySingle(e.target.checked)} />
                        {onlySingle && <CheckCircle size={12} className="text-black" />}
                      </div>
                      <span className="text-sm text-[#CCC] group-hover:text-white transition-colors">Sólo usuarios con 1 carga (Mes anterior)</span>
                    </label>

                    <div className="flex items-center gap-3">
                       <label className="text-sm text-[#CCC]">Límite filas:</label>
                       <input 
                         type="number" 
                         value={maxRows} 
                         onChange={e => setMaxRows(parseInt(e.target.value) || 0)}
                         className="w-20 bg-[#111418] border border-[#333] rounded px-2 py-1 text-sm text-white focus:border-[#C7F24A] outline-none" 
                       />
                       <span className="text-xs text-[#555]">(0 = Sin límite)</span>
                    </div>
                  </div>

                </div>
              </div>

              {/* Action Bar */}
              <div className="flex flex-col sm:flex-row gap-4 pt-4 border-t border-[#2A2A2A]">
                <button 
                  onClick={handleProcess}
                  disabled={isProcessing}
                  className="flex-1 bg-gradient-to-r from-[#C7F24A] to-[#D4FF4A] text-[#0D1117] font-bold py-3 rounded-xl shadow-[0_8px_18px_rgba(199,242,74,0.15)] hover:translate-y-[-2px] transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                >
                  {isProcessing ? 'Analizando...' : <> <Filter size={18} /> Procesar Comparación </>}
                </button>
                
                <button 
                  onClick={handleSortChange}
                  className="px-6 py-3 bg-[#24364A] text-[#EAF2FF] font-bold rounded-xl hover:bg-[#1F3A5F] transition-colors flex items-center gap-2 text-sm border border-[#2A2A2A]"
                >
                  <ArrowDownUp size={16} /> Orden: {sortMode === 'monto' ? '$$$' : 'Cant.'}
                </button>
              </div>
            </div>

            {/* Results Section */}
            {stats && results && (
              <div className="animate-fade-in">
                {/* Summary Stats */}
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                   <StatCard label="Usuarios Previos" value={stats.uniquePrev} subtext={`Total Cargas: ${stats.totalPrev}`} />
                   <StatCard label="Monto Previo" value={`$${(stats.totalPrevMonto / 1000000).toFixed(1)}M`} subtext="Volumen total" />
                   <StatCard label="Usuarios Perdidos" value={stats.droppedCount} type="bad" subtext={`${((stats.droppedCount / stats.uniquePrev)*100).toFixed(1)}% Churn`} />
                   <StatCard label="Volumen Perdido" value={`$${(stats.droppedMonto / 1000000).toFixed(2)}M`} type="bad" />
                </div>

                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                   <ResultTable 
                      title="Turno Mañana (06-14)" 
                      users={results.TM} 
                      badgeColor="bg-[#F59E0B]" 
                      onCopy={() => copyTurno(results.TM)}
                   />
                   <ResultTable 
                      title="Turno Tarde (14-22)" 
                      users={results.TT} 
                      badgeColor="bg-[#C7F24A]" 
                      onCopy={() => copyTurno(results.TT)}
                   />
                   <ResultTable 
                      title="Turno Noche (22-06)" 
                      users={results.TN} 
                      badgeColor="bg-[#7A5CFF]" 
                      onCopy={() => copyTurno(results.TN)}
                   />
                </div>
              </div>
            )}

          </div>
        );
      }

      const root = createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
