<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Recuperación - Tinder Style</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 20px 0;
            border-bottom: 2px solid #eee;
            margin-bottom: 20px;
        }

        h1 {
            color: #5a67d8;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #718096;
            font-size: 1.1rem;
        }

        /* Panel de control */
        .control-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 30px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 15px;
            border: 2px solid #e2e8f0;
        }

        .btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f56565 0%, #c53030 100%);
        }

        /* Filtros de progreso */
        .progress-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
            padding: 15px;
            background: #edf2f7;
            border-radius: 12px;
        }

        .filter-btn {
            padding: 8px 16px;
            background: white;
            border: 2px solid #cbd5e0;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn.active {
            background: #5a67d8;
            color: white;
            border-color: #5a67d8;
        }

        .filter-btn:hover:not(.active) {
            border-color: #5a67d8;
            color: #5a67d8;
        }

        /* Stats */
        .stats {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            flex: 1;
            min-width: 180px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border-left: 5px solid #5a67d8;
        }

        .stat-card.recovered {
            border-left-color: #48bb78;
        }

        .stat-card.contacted {
            border-left-color: #ed8936;
        }

        .stat-card.playing {
            border-left-color: #9f7aea;
        }

        .stat-card.deleted {
            border-left-color: #f56565;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2d3748;
        }

        .stat-label {
            color: #718096;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        /* Tarjetas tipo Tinder */
        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .contact-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            border: 2px solid #e2e8f0;
            position: relative;
            overflow: hidden;
        }

        .contact-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.12);
        }

        .contact-card.playing {
            border-color: #9f7aea;
            background: linear-gradient(to bottom right, #faf5ff, white);
        }

        .contact-card.contacted {
            border-color: #ed8936;
            background: linear-gradient(to bottom right, #fffaf0, white);
        }

        .contact-card.recovered {
            border-color: #48bb78;
            background: linear-gradient(to bottom right, #f0fff4, white);
        }

        .contact-card.deleted {
            border-color: #f56565;
            background: linear-gradient(to bottom right, #fff5f5, white);
            opacity: 0.7;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 10px;
        }

        .contact-id {
            font-weight: 700;
            font-size: 1.4rem;
            color: #2d3748;
            font-family: 'Courier New', monospace;
        }

        .origin-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .origin-planilla {
            background: #bee3f8;
            color: #2c5282;
        }

        .origin-pc {
            background: #c6f6d5;
            color: #276749;
        }

        .card-status {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-en-contacto {
            background: #c6f6d5;
            color: #276749;
        }

        .status-mensaje-enviado {
            background: #fed7d7;
            color: #c53030;
        }

        .status-no-wsp {
            background: #e2e8f0;
            color: #4a5568;
        }

        .card-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #e2e8f0;
        }

        .action-btn {
            flex: 1;
            min-width: 120px;
            padding: 10px 15px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .action-btn.edit {
            background: #e2e8f0;
            color: #4a5568;
        }

        .action-btn.edit:hover {
            background: #cbd5e0;
        }

        .action-btn.whatsapp {
            background: #48bb78;
            color: white;
        }

        .action-btn.whatsapp:hover {
            background: #38a169;
        }

        .action-btn.delete {
            background: #fed7d7;
            color: #c53030;
        }

        .action-btn.delete:hover {
            background: #feb2b2;
        }

        /* Modal de edición */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            display: none;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 20px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            padding: 25px;
            border-bottom: 2px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #718096;
        }

        .modal-body {
            padding: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        .form-select, .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            transition: border 0.3s;
        }

        .form-select:focus, .form-input:focus {
            outline: none;
            border-color: #5a67d8;
        }

        .toggle-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .toggle-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toggle-checkbox {
            width: 18px;
            height: 18px;
        }

        .modal-footer {
            padding: 20px 25px;
            border-top: 2px solid #e2e8f0;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
                border-radius: 15px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .cards-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .control-panel {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .stat-card {
                min-width: 100%;
            }
        }

        @media (max-width: 480px) {
            .card-actions {
                flex-direction: column;
            }
            
            .action-btn {
                width: 100%;
            }
        }

        /* Notificaciones */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: #48bb78;
            color: white;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateX(150%);
            transition: transform 0.4s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: #f56565;
        }

        .notification.warning {
            background: #ed8936;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-users"></i> Gestor de Recuperación</h1>
            <p class="subtitle">Sistema tipo Tinder para gestión de contactos</p>
        </header>

        <div class="control-panel">
            <button class="btn" id="btnImport"><i class="fas fa-file-import"></i> Importar CSV</button>
            <button class="btn btn-secondary" id="btnExport"><i class="fas fa-file-export"></i> Exportar CSV</button>
            <button class="btn btn-warning" id="btnExportVCF"><i class="fas fa-address-book"></i> Exportar VCF</button>
            <button class="btn btn-danger" id="btnReset"><i class="fas fa-redo"></i> Limpiar Datos</button>
            <input type="file" id="fileInput" accept=".csv" style="display: none;">
        </div>

        <!-- Filtros de progreso -->
        <div class="progress-filters">
            <button class="filter-btn active" data-filter="all">Todos (<span id="countAll">0</span>)</button>
            <button class="filter-btn" data-filter="playing">Jugando (<span id="countPlaying">0</span>)</button>
            <button class="filter-btn" data-filter="contacted">Contactados (<span id="countContacted">0</span>)</button>
            <button class="filter-btn" data-filter="recovered">Recuperados (<span id="countRecovered">0</span>)</button>
            <button class="filter-btn" data-filter="responded">Respondidos (<span id="countResponded">0</span>)</button>
            <button class="filter-btn" data-filter="deleted">Eliminados (<span id="countDeleted">0</span>)</button>
        </div>

        <!-- Stats -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="statTotal">0</div>
                <div class="stat-label">Total Contactos</div>
            </div>
            <div class="stat-card recovered">
                <div class="stat-value" id="statRecovered">0</div>
                <div class="stat-label">Recuperados</div>
            </div>
            <div class="stat-card contacted">
                <div class="stat-value" id="statContacted">0</div>
                <div class="stat-label">Contactados</div>
            </div>
            <div class="stat-card playing">
                <div class="stat-value" id="statPlaying">0</div>
                <div class="stat-label">Jugando</div>
            </div>
            <div class="stat-card deleted">
                <div class="stat-value" id="statDeleted">0</div>
                <div class="stat-label">Eliminados</div>
            </div>
        </div>

        <!-- Contenedor de tarjetas -->
        <div class="cards-container" id="cardsContainer">
            <!-- Las tarjetas se generan aquí -->
        </div>
    </div>

    <!-- Modal de edición -->
    <div class="modal-overlay" id="editModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Editar Contacto</h3>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">ID del Contacto</label>
                    <input type="text" class="form-input" id="editId" readonly>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Estado</label>
                    <select class="form-select" id="editEstado">
                        <option value="MENSAJE ENVIADO">MENSAJE ENVIADO</option>
                        <option value="EN CONTACTO">EN CONTACTO</option>
                        <option value="NO ESTA EN WSP">NO ESTA EN WSP</option>
                        <option value="A CONTACTAR">A CONTACTAR</option>
                        <option value="SIN REVISAR">SIN REVISAR</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Opciones</label>
                    <div class="toggle-group">
                        <div class="toggle-item">
                            <input type="checkbox" class="toggle-checkbox" id="editRespondido">
                            <label for="editRespondido">Respondido</label>
                        </div>
                        <div class="toggle-item">
                            <input type="checkbox" class="toggle-checkbox" id="editRecuperado">
                            <label for="editRecuperado">Recuperado</label>
                        </div>
                        <div class="toggle-item">
                            <input type="checkbox" class="toggle-checkbox" id="editInteresado">
                            <label for="editInteresado">Interesado en jugar</label>
                        </div>
                        <div class="toggle-item">
                            <input type="checkbox" class="toggle-checkbox" id="editEliminado">
                            <label for="editEliminado">Eliminado</label>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Origen</label>
                    <select class="form-select" id="editOrigen">
                        <option value="planilla">Planilla</option>
                        <option value="PC">PC</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Notas</label>
                    <textarea class="form-input" id="editNotas" rows="3" placeholder="Agregar notas..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="cancelEdit">Cancelar</button>
                <button class="btn btn-secondary" id="saveEdit">Guardar Cambios</button>
            </div>
        </div>
    </div>

    <!-- Notificación -->
    <div class="notification" id="notification">
        <i class="fas fa-check-circle"></i>
        <span id="notificationText">Operación realizada con éxito</span>
    </div>

    <script>
        // Base de datos en memoria
        let contactos = [];
        let contactoEditando = null;
        let filtroActual = 'all';

        // Estados disponibles
        const estados = {
            'EN CONTACTO': 'status-en-contacto',
            'MENSAJE ENVIADO': 'status-mensaje-enviado',
            'NO ESTA EN WSP': 'status-no-wsp',
            'A CONTACTAR': 'status-en-contacto',
            'SIN REVISAR': 'status-no-wsp'
        };

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            cargarDatosGuardados();
            inicializarEventos();
            renderizarContactos();
            actualizarEstadisticas();
        });

        // Eventos
        function inicializarEventos() {
            // Botones principales
            document.getElementById('btnImport').addEventListener('click', () => document.getElementById('fileInput').click());
            document.getElementById('btnExport').addEventListener('click', exportarCSV);
            document.getElementById('btnExportVCF').addEventListener('click', exportarVCF);
            document.getElementById('btnReset').addEventListener('click', resetearDatos);
            document.getElementById('fileInput').addEventListener('change', importarCSV);

            // Modal
            document.getElementById('closeModal').addEventListener('click', cerrarModal);
            document.getElementById('cancelEdit').addEventListener('click', cerrarModal);
            document.getElementById('saveEdit').addEventListener('click', guardarEdicion);

            // Filtros
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    filtroActual = btn.dataset.filter;
                    renderizarContactos();
                });
            });
        }

        // ==================== FUNCIONES PRINCIPALES ====================

        // Importar CSV con formato específico
        function importarCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const contenido = e.target.result;
                const lineas = contenido.split('\n');
                
                if (lineas.length === 0) {
                    mostrarNotificacion('Archivo vacío', 'error');
                    return;
                }

                // Leer encabezados
                const headers = lineas[0].split(',').map(h => h.trim());
                
                // Procesar cada línea
                const nuevosContactos = [];
                for (let i = 1; i < lineas.length; i++) {
                    if (lineas[i].trim() === '') continue;
                    
                    const valores = parseCSVLine(lineas[i]);
                    if (valores.length < headers.length) continue;
                    
                    const contacto = {};
                    
                    // Mapear columnas según el formato de la planilla
                    for (let j = 0; j < headers.length; j++) {
                        contacto[headers[j]] = valores[j] || '';
                    }
                    
                    // Convertir a nuestro formato interno
                    const id = contacto.usuarios || contacto.usuario || '';
                    if (id === 'eliminado' || !id) continue;
                    
                    // Verificar si ya existe
                    const existe = contactos.find(c => c.id === id);
                    if (existe) {
                        // Actualizar contacto existente
                        actualizarContactoDesdeCSV(existe, contacto);
                    } else {
                        // Crear nuevo contacto
                        const nuevoContacto = crearContactoDesdeCSV(id, contacto);
                        nuevosContactos.push(nuevoContacto);
                    }
                }
                
                // Agregar nuevos contactos
                contactos.push(...nuevosContactos);
                
                // Detectar origen
                nuevosContactos.forEach(c => {
                    if (c.origen === 'planilla') {
                        c.origen = 'planilla';
                    }
                });
                
                guardarDatos();
                renderizarContactos();
                actualizarEstadisticas();
                
                mostrarNotificacion(`${nuevosContactos.length} contactos importados`, 'success');
                
                // Resetear input file
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }

        // Parsear línea CSV considerando comillas
        function parseCSVLine(line) {
            const valores = [];
            let valorActual = '';
            let entreComillas = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    entreComillas = !entreComillas;
                } else if (char === ',' && !entreComillas) {
                    valores.push(valorActual.trim());
                    valorActual = '';
                } else {
                    valorActual += char;
                }
            }
            
            valores.push(valorActual.trim());
            return valores;
        }

        // Crear contacto desde CSV
        function crearContactoDesdeCSV(id, datos) {
            return {
                id: id,
                estado: datos.estado || datos['estado actual'] || 'SIN REVISAR',
                respondido: (datos['VISTO, RESPONDIDO?'] || '').toUpperCase() === 'SI',
                recuperado: (datos.RECUPERADO || '').toUpperCase() === 'SI',
                interesado: (datos['interesado en jugar?'] || '').toUpperCase() === 'SI',
                origen: 'planilla', // Nuevos del CSV son de planilla
                notas: '',
                eliminado: false,
                fechaContacto: new Date().toISOString().split('T')[0],
                // Campos adicionales para exportación
                _turno: datos['TURNO DE LAS CARGAS'] || '',
                _yaContactados: datos['ya contactados'] || '',
                _recuperados: datos['recuperados!'] || '',
                _cargando: datos['actualmente cargando'] || ''
            };
        }

        // Actualizar contacto existente desde CSV
        function actualizarContactoDesdeCSV(contacto, datos) {
            // Solo actualizar si los datos del CSV son más recientes
            contacto.estado = datos['estado actual'] || contacto.estado;
            contacto.respondido = (datos['VISTO, RESPONDIDO?'] || '').toUpperCase() === 'SI' || contacto.respondido;
            contacto.recuperado = (datos.RECUPERADO || '').toUpperCase() === 'SI' || contacto.recuperado;
            contacto.interesado = (datos['interesado en jugar?'] || '').toUpperCase() === 'SI' || contacto.interesado;
            contacto._turno = datos['TURNO DE LAS CARGAS'] || contacto._turno;
        }

        // Exportar CSV en formato compatible
        function exportarCSV() {
            if (contactos.length === 0) {
                mostrarNotificacion('No hay datos para exportar', 'warning');
                return;
            }

            // Preparar datos en formato de planilla
            const filas = [];
            
            // Encabezados (igual que tu CSV)
            const headers = [
                'usuarios',
                'estado de revision',
                '',
                'estado actual',
                '"VISTO, RESPONDIDO?"',
                'RECUPERADO',
                'TURNO DE LAS CARGAS',
                'interesado en jugar?',
                'ya contactados',
                'recuperados!',
                'actualmente cargando',
                'TURNO MAÑANA',
                'TURNO TARDE',
                'TURNO NOCHE',
                'contactos a borrar'
            ];
            
            filas.push(headers.join(','));
            
            // Agregar cada contacto
            contactos.forEach(contacto => {
                // Determinar "estado de revision" basado en estado actual
                let estadoRevision = '';
                if (contacto.estado === 'MENSAJE ENVIADO') estadoRevision = 'promo enviada';
                else if (contacto.estado === 'NO ESTA EN WSP') estadoRevision = 'no esta en wsp';
                else if (contacto.estado === 'EN CONTACTO') estadoRevision = 'esta cargando';
                else estadoRevision = '???';
                
                const fila = [
                    contacto.eliminado ? 'eliminado' : contacto.id,
                    estadoRevision,
                    '', // Columna vacía
                    contacto.estado,
                    contacto.respondido ? 'SI' : 'NO',
                    contacto.recuperado ? 'SI' : 'NO',
                    contacto._turno || '',
                    contacto.interesado ? 'SI' : 'NO',
                    contacto._yaContactados || '',
                    contacto._recuperados || '',
                    contacto._cargando || '',
                    '', // TURNO MAÑANA
                    '', // TURNO TARDE
                    '', // TURNO NOCHE
                    contacto.eliminado ? contacto.id : 'eliminado'
                ];
                
                filas.push(fila.map(v => `"${v}"`).join(','));
            });
            
            const csv = filas.join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            
            link.href = url;
            link.download = `contactos_recuperacion_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            mostrarNotificacion('CSV exportado con éxito', 'success');
        }

        // Exportar VCF filtrado
        function exportarVCF() {
            // Filtrar contactos según criterios (activos, no eliminados, etc.)
            const contactosParaExportar = contactos.filter(c => 
                !c.eliminado && 
                c.estado !== 'NO ESTA EN WSP' &&
                c.estado !== 'ELIMINADO'
            );
            
            if (contactosParaExportar.length === 0) {
                mostrarNotificacion('No hay contactos para exportar a VCF', 'warning');
                return;
            }
            
            // Crear contenido VCF simple
            let vcf = '';
            contactosParaExportar.forEach(contacto => {
                vcf += `BEGIN:VCARD\n`;
                vcf += `VERSION:3.0\n`;
                vcf += `FN:${contacto.id}\n`;
                vcf += `TEL;TYPE=CELL:${contacto.id}\n`;
                vcf += `NOTE:Estado: ${contacto.estado}. Recuperado: ${contacto.recuperado ? 'SI' : 'NO'}\n`;
                vcf += `END:VCARD\n\n`;
            });
            
            const blob = new Blob([vcf], { type: 'text/vcard;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            
            link.href = url;
            link.download = `contactos_whatsapp_${new Date().toISOString().split('T')[0]}.vcf`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            mostrarNotificacion(`${contactosParaExportar.length} contactos exportados a VCF`, 'success');
        }

        // ==================== INTERFAZ ====================

        // Renderizar contactos filtrados
        function renderizarContactos() {
            const container = document.getElementById('cardsContainer');
            container.innerHTML = '';
            
            // Filtrar contactos
            let contactosFiltrados = contactos;
            
            switch (filtroActual) {
                case 'playing':
                    contactosFiltrados = contactos.filter(c => c.interesado && !c.eliminado);
                    break;
                case 'contacted':
                    contactosFiltrados = contactos.filter(c => c.estado === 'EN CONTACTO' && !c.eliminado);
                    break;
                case 'recovered':
                    contactosFiltrados = contactos.filter(c => c.recuperado && !c.eliminado);
                    break;
                case 'responded':
                    contactosFiltrados = contactos.filter(c => c.respondido && !c.eliminado);
                    break;
                case 'deleted':
                    contactosFiltrados = contactos.filter(c => c.eliminado);
                    break;
                case 'all':
                default:
                    contactosFiltrados = contactos;
            }
            
            // Ordenar: recuperados primero, luego por estado
            contactosFiltrados.sort((a, b) => {
                if (a.recuperado !== b.recuperado) return b.recuperado - a.recuperado;
                if (a.interesado !== b.interesado) return b.interesado - a.interesado;
                return a.id.localeCompare(b.id);
            });
            
            // Crear tarjetas
            contactosFiltrados.forEach(contacto => {
                const card = crearTarjetaContacto(contacto);
                container.appendChild(card);
            });
            
            // Actualizar contadores de filtros
            actualizarContadoresFiltros();
        }

        // Crear tarjeta individual
        function crearTarjetaContacto(contacto) {
            const div = document.createElement('div');
            div.className = `contact-card ${contacto.interesado ? 'playing' : ''} ${contacto.eliminado ? 'deleted' : ''}`;
            
            // Determinar clase de estado
            const estadoClass = estados[contacto.estado] || 'status-no-wsp';
            
            div.innerHTML = `
                <div class="card-header">
                    <div class="contact-id">${contacto.id}</div>
                    <span class="origin-badge origin-${contacto.origen}">${contacto.origen}</span>
                </div>
                
                <div class="card-status">
                    <span class="status-badge ${estadoClass}">${contacto.estado}</span>
                    ${contacto.respondido ? '<span class="status-badge status-en-contacto">Respondido</span>' : ''}
                    ${contacto.recuperado ? '<span class="status-badge status-en-contacto">Recuperado</span>' : ''}
                    ${contacto.interesado ? '<span class="status-badge" style="background:#e9d8fd;color:#553c9a;">Jugando</span>' : ''}
                    ${contacto.eliminado ? '<span class="status-badge" style="background:#fed7d7;color:#c53030;">Eliminado</span>' : ''}
                </div>
                
                <div style="margin: 15px 0; color: #4a5568; font-size: 0.95rem;">
                    <div><strong>Contacto:</strong> ${contacto.fechaContacto || 'Sin fecha'}</div>
                    ${contacto.notas ? `<div style="margin-top: 10px; padding: 10px; background: #f7fafc; border-radius: 8px;">${contacto.notas}</div>` : ''}
                </div>
                
                <div class="card-actions">
                    <button class="action-btn edit" data-id
                                            ="${contacto.id}">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button class="action-btn whatsapp" data-id="${contacto.id}">
                        <i class="fab fa-whatsapp"></i> WhatsApp
                    </button>
                    <button class="action-btn delete" data-id="${contacto.id}">
                        <i class="fas fa-trash"></i> ${contacto.eliminado ? 'Restaurar' : 'Eliminar'}
                    </button>
                </div>
            `;
            
            // Agregar eventos a los botones
            const btnEditar = div.querySelector('.action-btn.edit');
            const btnWhatsapp = div.querySelector('.action-btn.whatsapp');
            const btnEliminar = div.querySelector('.action-btn.delete');
            
            btnEditar.addEventListener('click', () => abrirModalEdicion(contacto.id));
            btnWhatsapp.addEventListener('click', () => abrirWhatsapp(contacto.id));
            btnEliminar.addEventListener('click', () => toggleEliminar(contacto.id));
            
            return div;
        }

        // Abrir WhatsApp con el contacto
        function abrirWhatsapp(id) {
            // Asumimos que el ID es el número (sin +54)
            const numero = id.replace(/\D/g, '');
            if (numero.length >= 8) {
                window.open(`https://wa.me/54${numero}`, '_blank');
            } else {
                mostrarNotificacion('ID no válido para WhatsApp', 'warning');
            }
        }

        // Toggle eliminar/restaurar contacto
        function toggleEliminar(id) {
            const contacto = contactos.find(c => c.id === id);
            if (contacto) {
                contacto.eliminado = !contacto.eliminado;
                guardarDatos();
                renderizarContactos();
                actualizarEstadisticas();
                
                mostrarNotificacion(
                    contacto.eliminado ? 'Contacto eliminado' : 'Contacto restaurado',
                    contacto.eliminado ? 'warning' : 'success'
                );
            }
        }

        // ==================== MODAL DE EDICIÓN ====================

        // Abrir modal para editar contacto
        function abrirModalEdicion(id) {
            contactoEditando = contactos.find(c => c.id === id);
            if (!contactoEditando) return;
            
            document.getElementById('editId').value = contactoEditando.id;
            document.getElementById('editEstado').value = contactoEditando.estado;
            document.getElementById('editRespondido').checked = contactoEditando.respondido;
            document.getElementById('editRecuperado').checked = contactoEditando.recuperado;
            document.getElementById('editInteresado').checked = contactoEditando.interesado;
            document.getElementById('editEliminado').checked = contactoEditando.eliminado;
            document.getElementById('editOrigen').value = contactoEditando.origen;
            document.getElementById('editNotas').value = contactoEditando.notas || '';
            
            document.getElementById('editModal').classList.add('active');
        }

        // Cerrar modal
        function cerrarModal() {
            document.getElementById('editModal').classList.remove('active');
            contactoEditando = null;
        }

        // Guardar cambios del modal
        function guardarEdicion() {
            if (!contactoEditando) return;
            
            contactoEditando.estado = document.getElementById('editEstado').value;
            contactoEditando.respondido = document.getElementById('editRespondido').checked;
            contactoEditando.recuperado = document.getElementById('editRecuperado').checked;
            contactoEditando.interesado = document.getElementById('editInteresado').checked;
            contactoEditando.eliminado = document.getElementById('editEliminado').checked;
            contactoEditando.origen = document.getElementById('editOrigen').value;
            contactoEditando.notas = document.getElementById('editNotas').value;
            
            guardarDatos();
            renderizarContactos();
            actualizarEstadisticas();
            cerrarModal();
            
            mostrarNotificacion('Cambios guardados correctamente', 'success');
        }

        // ==================== ESTADÍSTICAS ====================

        // Actualizar todas las estadísticas
        function actualizarEstadisticas() {
            const total = contactos.length;
            const recuperados = contactos.filter(c => c.recuperado).length;
            const contactados = contactos.filter(c => c.estado === 'EN CONTACTO').length;
            const jugando = contactos.filter(c => c.interesado).length;
            const eliminados = contactos.filter(c => c.eliminado).length;
            
            document.getElementById('statTotal').textContent = total;
            document.getElementById('statRecovered').textContent = recuperados;
            document.getElementById('statContacted').textContent = contactados;
            document.getElementById('statPlaying').textContent = jugando;
            document.getElementById('statDeleted').textContent = eliminados;
            
            // Porcentajes
            const porcentajeRecuperados = total > 0 ? Math.round((recuperados / total) * 100) : 0;
            const porcentajeContactados = total > 0 ? Math.round((contactados / total) * 100) : 0;
            
            // Actualizar contadores de filtros
            document.getElementById('countAll').textContent = total;
            document.getElementById('countPlaying').textContent = jugando;
            document.getElementById('countContacted').textContent = contactados;
            document.getElementById('countRecovered').textContent = recuperados;
            document.getElementById('countResponded').textContent = contactos.filter(c => c.respondido).length;
            document.getElementById('countDeleted').textContent = eliminados;
        }

        // Actualizar solo contadores de filtros
        function actualizarContadoresFiltros() {
            document.getElementById('countAll').textContent = contactos.length;
            document.getElementById('countPlaying').textContent = contactos.filter(c => c.interesado && !c.eliminado).length;
            document.getElementById('countContacted').textContent = contactos.filter(c => c.estado === 'EN CONTACTO' && !c.eliminado).length;
            document.getElementById('countRecovered').textContent = contactos.filter(c => c.recuperado && !c.eliminado).length;
            document.getElementById('countResponded').textContent = contactos.filter(c => c.respondido && !c.eliminado).length;
            document.getElementById('countDeleted').textContent = contactos.filter(c => c.eliminado).length;
        }

        // ==================== UTILIDADES ====================

        // Mostrar notificación
        function mostrarNotificacion(mensaje, tipo = 'success') {
            const notif = document.getElementById('notification');
            const notifText = document.getElementById('notificationText');
            
            notifText.textContent = mensaje;
            notif.className = 'notification';
            notif.classList.add(tipo);
            notif.classList.add('show');
            
            setTimeout(() => {
                notif.classList.remove('show');
            }, 3000);
        }

        // Guardar datos en localStorage
        function guardarDatos() {
            try {
                localStorage.setItem('gestorContactos', JSON.stringify(contactos));
            } catch (e) {
                console.error('Error guardando datos:', e);
            }
        }

        // Cargar datos guardados
        function cargarDatosGuardados() {
            try {
                const datos = localStorage.getItem('gestorContactos');
                if (datos) {
                    contactos = JSON.parse(datos);
                }
            } catch (e) {
                console.error('Error cargando datos:', e);
                contactos = [];
            }
        }

        // Resetear todos los datos
        function resetearDatos() {
            if (confirm('¿Estás seguro de eliminar todos los datos? Esto no se puede deshacer.')) {
                contactos = [];
                localStorage.removeItem('gestorContactos');
                renderizarContactos();
                actualizarEstadisticas();
                mostrarNotificacion('Todos los datos han sido eliminados', 'warning');
            }
        }

        // Datos de ejemplo para probar
        function cargarDatosEjemplo() {
            if (contactos.length === 0) {
                contactos = [
                    {
                        id: "0507gra1",
                        estado: "MENSAJE ENVIADO",
                        respondido: false,
                        recuperado: false,
                        interesado: true,
                        origen: "planilla",
                        notas: "Promoción enviada, sin respuesta aún",
                        eliminado: false,
                        fechaContacto: "2024-01-10",
                        _turno: "TN"
                    },
                    {
                        id: "1053nan",
                        estado: "EN CONTACTO",
                        respondido: true,
                        recuperado: true,
                        interesado: true,
                        origen: "PC",
                        notas: "Cliente recuperado, jugando actualmente",
                        eliminado: false,
                        fechaContacto: "2024-01-09",
                        _turno: "TM"
                    },
                    {
                        id: "0fab066",
                        estado: "NO ESTA EN WSP",
                        respondido: false,
                        recuperado: false,
                        interesado: false,
                        origen: "planilla",
                        notas: "Número no existe en WhatsApp",
                        eliminado: true,
                        fechaContacto: "2024-01-08",
                        _turno: ""
                    }
                ];
                guardarDatos();
                renderizarContactos();
                actualizarEstadisticas();
            }
        }

        // Cargar ejemplo si no hay datos
        if (!localStorage.getItem('gestorContactos')) {
            cargarDatosEjemplo();
        }
    </script>
</body>
</html>
