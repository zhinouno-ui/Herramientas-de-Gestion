<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Gestor de Contactos â€“ RevinculaciÃ³n</title>

<style>
:root{
  --bg:#0f172a;--panel:#111827;--card:#020617;
  --text:#e5e7eb;--muted:#9ca3af;
  --accent:#22c55e;--warn:#f59e0b;
  --danger:#ef4444;--info:#38bdf8;
}

*{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto}
body{margin:0;background:#020617;color:var(--text)}

header{
  padding:16px 20px;
  border-bottom:1px solid #1f2937;
}
header h1{margin:0;font-size:18px}

.wrap{
  display:grid;
  grid-template-columns:280px 1fr;
  height:calc(100vh - 60px);
}

aside{
  border-right:1px solid #1f2937;
  padding:16px;
  display:flex;
  flex-direction:column;
  gap:12px;
  position:sticky;
  top:0;
  height:calc(100vh - 60px);
  overflow:auto;
}

main{
  padding:16px;
  overflow:auto;
}

.card{
  background:rgba(2,6,23,.9);
  border:1px solid #1f2937;
  border-radius:14px;
  padding:14px;
}

.card h3{
  margin:0 0 8px;
  font-size:14px;
  color:#cbd5f5;
}

.btn{
  background:#020617;
  border:1px solid #1f2937;
  color:var(--text);
  padding:6px 8px;
  border-radius:10px;
  cursor:pointer;
  font-size:12px;
}

.btn:hover{border-color:#334155}
.btn.accent{background:rgba(34,197,94,.1);border-color:rgba(34,197,94,.4)}
.btn.warn{background:rgba(245,158,11,.1);border-color:rgba(245,158,11,.4)}
.btn.danger{background:rgba(239,68,68,.1);border-color:rgba(239,68,68,.4)}
.btn.info{background:rgba(56,189,248,.1);border-color:rgba(56,189,248,.4)}

input,select{
  width:100%;
  background:#020617;
  border:1px solid #1f2937;
  color:var(--text);
  padding:8px 10px;
  border-radius:10px;
}

.stats{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:8px;
}

.stat{
  background:#020617;
  border:1px solid #1f2937;
  border-radius:12px;
  padding:10px;
}
.stat b{font-size:18px}

table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #1f2937;font-size:13px}
th{color:#cbd5f5;text-align:left}
tr:hover{background:#020617}

.tag{
  padding:2px 8px;
  border-radius:999px;
  border:1px solid #1f2937;
  font-size:11px;
}
.t-info{border-color:rgba(56,189,248,.6);color:#7dd3fc}

.actions{display:flex;gap:4px;flex-wrap:wrap}

/* TOOLTIP */
[data-tip]{position:relative}
[data-tip]:hover::after{
  content:attr(data-tip);
  position:absolute;
  bottom:130%;
  left:50%;
  transform:translateX(-50%);
  background:#020617;
  border:1px solid #334155;
  padding:6px 8px;
  border-radius:8px;
  font-size:11px;
  white-space:nowrap;
  z-index:999;
}
</style>
</head>

<body>
<header>
  <h1>ðŸ“‡ Gestor de Contactos â€“ RevinculaciÃ³n</h1>
</header>

<div class="wrap">
<aside>

<div class="card">
<h3>Importar VCF</h3>
<input type="file" id="csvFile" accept=".vcf">
<input id="csvOrigen" placeholder="Origen (pc1, pc2...)">
<button class="btn accent" onclick="importCSV()">Importar</button>
</div>

<div class="card">
<h3>BÃºsqueda</h3>
<input id="search" placeholder="Buscar nombre o telÃ©fono" oninput="render()">
<select id="fEstado" onchange="render()">
<option value="">Todos</option>
<option value="no_contactado">No contactado</option>
<option value="contactado">Contactado</option>
<option value="interesado">Interesado</option>
<option value="desinteresado">Desinteresado</option>
<option value="sin_whatsapp">Sin WhatsApp</option>
</select>
</div>

<div class="card">
<h3>Filtro por Origen</h3>
<label>Mostrar hasta pc<b id="sliderVal">5</b></label>
<input type="range" id="fSlider" min="1" max="5" value="5" oninput="updateSlider()">
<label>
<input type="checkbox" id="fExclude" onchange="render()"> Excluir superiores
</label>
</div>

<div class="card">
<h3>EstadÃ­sticas</h3>
<div class="stats">
<div class="stat"><b id="stTotal">0</b><div>Total</div></div>
<div class="stat"><b id="stInter">0</b><div>Interesados</div></div>
<div class="stat"><b id="stDes">0</b><div>Desinteresados</div></div>
<div class="stat"><b id="stNo">0</b><div>No contactados</div></div>
</div>
</div>

<button class="btn danger" onclick="vaciarDB()">Vaciar contactos</button>

</aside>

<main>
<div class="card">
<h3>Contactos</h3>
<table>
<thead>
<tr>
<th>Nombre</th><th>TelÃ©fono</th><th>Origen</th><th>Estado</th><th>Acciones</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>
</main>
</div>

<script>
let db;
indexedDB.open('contactosDB',1).onupgradeneeded=e=>{
  db=e.target.result;
  db.createObjectStore('contactos',{keyPath:'telefono'});
};
indexedDB.open('contactosDB',1).onsuccess=e=>{
  db=e.target.result;
  render();
};

function getAll(cb){
  db.transaction('contactos','readonly')
    .objectStore('contactos')
    .getAll().onsuccess=e=>cb(e.target.result||[]);
}
function put(c){
  db.transaction('contactos','readwrite')
    .objectStore('contactos').put(c);
}
function del(t){
  db.transaction('contactos','readwrite')
    .objectStore('contactos').delete(t);
}

function updateSlider(){
  sliderVal.innerText=fSlider.value;
  render();
}

function render(){
  getAll(all=>{
    const q=search.value.toLowerCase();
    const fe=fEstado.value;
    const max=parseInt(fSlider.value);
    const exclude=fExclude.checked;

    const arr=all.filter(c=>{
      if(q && !(c.nombre||'').toLowerCase().includes(q) && !c.telefono.includes(q)) return false;
      if(fe && c.estado!==fe) return false;

      if(c.origen){
        const pcs=c.origen.split(',')
          .map(o=>parseInt(o.replace('pc','')))
          .filter(n=>!isNaN(n));
        if(exclude) return pcs.every(n=>n<=max);
        return pcs.some(n=>n<=max);
      }
      return true;
    });

    tbody.innerHTML='';
    arr.forEach(c=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
<td contenteditable onblur="editName('${c.telefono}',this.innerText)">${c.nombre||''}</td>
<td>${c.telefono}</td>
<td><span class="tag t-info">${c.origen||''}</span></td>
<td><span class="tag">${c.estado}</span></td>
<td class="actions">
<button class="btn accent" data-tip="Interesado" onclick="setEstado('${c.telefono}','interesado')">âœ”</button>
<button class="btn warn" data-tip="Contactado" onclick="setEstado('${c.telefono}','contactado')">â˜Ž</button>
<button class="btn danger" data-tip="Desinteresado" onclick="setEstado('${c.telefono}','desinteresado')">âœ–</button>
<button class="btn" data-tip="Sin WhatsApp" onclick="setEstado('${c.telefono}','sin_whatsapp')">ðŸš«</button>
<button class="btn info" data-tip="Abrir WhatsApp" onclick="wa('${c.telefono}')">WA</button>
<button class="btn danger" data-tip="Eliminar" onclick="deleteContacto('${c.telefono}')">ðŸ—‘</button>
</td>`;
      tbody.appendChild(tr);
    });

    stTotal.innerText=all.length;
    stInter.innerText=all.filter(c=>c.estado==='interesado').length;
    stDes.innerText=all.filter(c=>c.estado==='desinteresado').length;
    stNo.innerText=all.filter(c=>c.estado==='no_contactado').length;
  });
}

function setEstado(t,e){
  getAll(all=>{
    const c=all.find(x=>x.telefono===t);
    if(!c) return;
    c.estado=e;
    put(c);
    render();
  });
}
function editName(t,n){
  getAll(all=>{
    const c=all.find(x=>x.telefono===t);
    if(c){c.nombre=n.trim();put(c);}
  });
}
function deleteContacto(t){
  if(confirm('Eliminar contacto?')){del(t);render();}
}
function wa(t){window.open('https://wa.me/'+t)}
function vaciarDB(){
  if(confirm('Borrar todos?')){
    db.transaction('contactos','readwrite')
      .objectStore('contactos').clear();
    render();
  }
}
</script>
</body>
</html>
