<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Gestor de Contactos â€“ RevinculaciÃ³n</title>

<style>
:root{
  --bg:#020617;
  --panel:#020617;
  --border:#1f2937;
  --text:#e5e7eb;
  --muted:#9ca3af;
  --accent:#22c55e;
  --warn:#f59e0b;
  --danger:#ef4444;
  --info:#38bdf8;
}

*{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto}
body{margin:0;background:var(--bg);color:var(--text)}

header{
  padding:14px 18px;
  border-bottom:1px solid var(--border);
}

.wrap{
  display:grid;
  grid-template-columns:300px 1fr;
  height:calc(100vh - 56px);
}

aside{
  padding:14px;
  border-right:1px solid var(--border);
  display:flex;
  flex-direction:column;
  gap:12px;
  position:sticky;
  top:0;
  height:100%;
  overflow:auto;
}

main{
  padding:14px;
  overflow:auto;
}

.card{
  background:#020617;
  border:1px solid var(--border);
  border-radius:14px;
  padding:12px;
}

.card h3{
  margin:0 0 8px;
  font-size:14px;
  color:#cbd5f5;
}

input,select{
  width:100%;
  background:#020617;
  border:1px solid var(--border);
  color:var(--text);
  padding:8px 10px;
  border-radius:10px;
}

.btn{
  background:#020617;
  border:1px solid var(--border);
  color:var(--text);
  padding:6px 8px;
  border-radius:10px;
  font-size:12px;
  cursor:pointer;
}
.btn:hover{border-color:#334155}
.btn.accent{border-color:rgba(34,197,94,.5)}
.btn.warn{border-color:rgba(245,158,11,.5)}
.btn.danger{border-color:rgba(239,68,68,.5)}
.btn.info{border-color:rgba(56,189,248,.5)}

.stats{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:8px;
}

.stat{
  border:1px solid var(--border);
  border-radius:10px;
  padding:8px;
}
.stat b{font-size:18px}

table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid var(--border);font-size:13px}
th{text-align:left;color:#cbd5f5}
tr:hover{background:#020617}

.tag{
  display:inline-block;
  margin:2px;
  padding:2px 8px;
  border-radius:999px;
  font-size:11px;
  border:1px solid rgba(56,189,248,.6);
  color:#7dd3fc;
}

.actions{display:flex;gap:4px;flex-wrap:wrap}

/* Tooltip */
[data-tip]{position:relative}
[data-tip]:hover::after{
  content:attr(data-tip);
  position:absolute;
  bottom:130%;
  left:50%;
  transform:translateX(-50%);
  background:#020617;
  border:1px solid #334155;
  padding:6px 8px;
  border-radius:8px;
  font-size:11px;
  white-space:nowrap;
  z-index:999;
}
</style>
</head>

<body>

<header>
<h1>ðŸ“‡ Gestor de Contactos â€“ RevinculaciÃ³n</h1>
</header>

<div class="wrap">

<aside>

<div class="card">
<h3>Importar VCF</h3>
<input type="file" id="file" accept=".vcf" multiple>
<input id="origenInput" placeholder="Origen (ej: PC1, PC2, PC chino)">
<button class="btn accent" onclick="importVCF()">Importar</button>
</div>

<div class="card">
<h3>BÃºsqueda</h3>
<input id="search" placeholder="Buscar nombre o telÃ©fono" oninput="render()">
<select id="estado" onchange="render()">
<option value="">Todos</option>
<option value="no_contactado">No contactado</option>
<option value="contactado">Contactado</option>
<option value="interesado">Interesado</option>
<option value="desinteresado">Desinteresado</option>
<option value="sin_whatsapp">Sin WhatsApp</option>
</select>
</div>

<div class="card">
<h3>Filtro por Origen</h3>
<div id="origenFilters"></div>
</div>

<div class="card">
<h3>EstadÃ­sticas</h3>
<div class="stats">
<div class="stat"><b id="stTotal">0</b><div>Total</div></div>
<div class="stat"><b id="stInter">0</b><div>Interesados</div></div>
<div class="stat"><b id="stDes">0</b><div>Desinteresados</div></div>
<div class="stat"><b id="stNo">0</b><div>No contactados</div></div>
</div>
</div>

<button class="btn danger" onclick="vaciar()">Vaciar todo</button>

</aside>

<main>

<div class="card">
<h3>Contactos</h3>
<table>
<thead>
<tr>
<th>Nombre</th>
<th>TelÃ©fono</th>
<th>Origen</th>
<th>Estado</th>
<th>Acciones</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

</main>
</div>

<script>
let db;
indexedDB.open('contactosDB',1).onupgradeneeded=e=>{
  db=e.target.result;
  db.createObjectStore('contactos',{keyPath:'telefono'});
};
indexedDB.open('contactosDB',1).onsuccess=e=>{
  db=e.target.result;
  render();
};

function getAll(cb){
  db.transaction('contactos','readonly')
    .objectStore('contactos')
    .getAll().onsuccess=e=>cb(e.target.result||[]);
}

function put(c){
  db.transaction('contactos','readwrite')
    .objectStore('contactos').put(c);
}

function importVCF(){
  const files=[...file.files];
  const origen=origenInput.value.trim();
  if(!files.length||!origen) return alert('Archivo y origen requeridos');

  files.forEach(f=>{
    const r=new FileReader();
    r.onload=e=>{
      e.target.result.split('BEGIN:VCARD').slice(1).forEach(card=>{
        const t=card.match(/TEL[^:]*:(.+)/i);
        if(!t) return;
        const telefono=t[1].replace(/\D/g,'');
        const n=card.match(/FN:(.+)/i);
        const nombre=n?n[1].trim():'';

        getAll(all=>{
          let c=all.find(x=>x.telefono===telefono);
          if(!c){
            put({
              telefono,
              nombre,
              origen:[origen],
              estado:'no_contactado',
              fecha:''
            });
          }else{
            if(!c.origen.includes(origen)){
              c.origen.push(origen);
            }
            if(!c.nombre && nombre){
              c.nombre=nombre;
            }
            put(c);
          }
        });
      });
      setTimeout(render,300);
    };
    r.readAsText(f);
  });
}

function buildOrigenFilters(all){
  const cont=document.getElementById('origenFilters');
  cont.innerHTML='';
  const set=new Set();
  all.forEach(c=>(c.origen||[]).forEach(o=>set.add(o)));
  [...set].sort().forEach(o=>{
    cont.innerHTML+=`
      <label style="display:block;font-size:12px">
        <input type="checkbox" value="${o}" onchange="render()"> ${o}
      </label>`;
  });
}

function render(){
  getAll(all=>{
    buildOrigenFilters(all);

    const q=search.value.toLowerCase();
    const e=estado.value;
    const selected=[...document.querySelectorAll('#origenFilters input:checked')].map(i=>i.value);

    const arr=all.filter(c=>{
      if(q && !(c.nombre||'').toLowerCase().includes(q) && !c.telefono.includes(q)) return false;
      if(e && c.estado!==e) return false;
      if(selected.length && !c.origen.some(o=>selected.includes(o))) return false;
      return true;
    });

    tbody.innerHTML='';
    arr.forEach(c=>{
      tbody.innerHTML+=`
      <tr>
        <td contenteditable onblur="editName('${c.telefono}',this.innerText)">${c.nombre||''}</td>
        <td>${c.telefono}</td>
        <td>${c.origen.map(o=>`<span class="tag">${o}</span>`).join(' ')}</td>
        <td><span class="tag">${c.estado}</span></td>
        <td class="actions">
          <button class="btn accent" data-tip="Interesado" onclick="setEstado('${c.telefono}','interesado')">âœ”</button>
          <button class="btn warn" data-tip="Contactado" onclick="setEstado('${c.telefono}','contactado')">â˜Ž</button>
          <button class="btn danger" data-tip="Desinteresado" onclick="setEstado('${c.telefono}','desinteresado')">âœ–</button>
          <button class="btn" data-tip="Sin WhatsApp" onclick="setEstado('${c.telefono}','sin_whatsapp')">ðŸš«</button>
          <button class="btn info" data-tip="Abrir WhatsApp" onclick="window.open('https://wa.me/${c.telefono}')">WA</button>
        </td>
      </tr>`;
    });

    stTotal.innerText=all.length;
    stInter.innerText=all.filter(c=>c.estado==='interesado').length;
    stDes.innerText=all.filter(c=>c.estado==='desinteresado').length;
    stNo.innerText=all.filter(c=>c.estado==='no_contactado').length;
  });
}

function setEstado(t,e){
  getAll(all=>{
    const c=all.find(x=>x.telefono===t);
    if(!c) return;
    c.estado=e;
    put(c);
    render();
  });
}

function editName(t,n){
  getAll(all=>{
    const c=all.find(x=>x.telefono===t);
    if(c){c.nombre=n.trim();put(c);}
  });
}

function vaciar(){
  if(confirm('Borrar todo?')){
    db.transaction('contactos','readwrite')
      .objectStore('contactos').clear();
    render();
  }
}
</script>

</body>
</html>
