
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Convertidor de CSV a VCF</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');
        body {
            font-family: 'Poppins', sans-serif;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .file-input-label {
            transition: all 0.3s ease;
        }
        .file-input-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .btn-download {
            transition: all 0.3s ease;
        }
        .btn-download:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        .btn-download:not(:disabled):hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(96, 165, 250, 0.5);
        }
    </style>
</head>
<body class="bg-gray-900 bg-gradient-to-br from-indigo-900 via-gray-900 to-purple-900 text-white min-h-screen flex items-center justify-center p-4">

    <div id="app" class="w-full max-w-2xl mx-auto">
        <div class="glass-card rounded-2xl shadow-2xl p-8 md:p-12">
            
            <header class="text-center mb-8">
                <h1 class="text-4xl md:text-5xl font-bold tracking-tight mb-2 bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-400">
                    Convertidor CSV a VCF
                </h1>
                <p class="text-gray-300 text-lg">Transforma tus listas de contactos en segundos.</p>
            </header>

            <main>
                <div class="space-y-8">
                    <!-- Step 1: Upload File -->
                    <div id="upload-step" class="text-center">
                        <input type="file" id="csv-file-input" class="hidden" accept=".csv, .txt, text/csv">
                        <label for="csv-file-input" class="file-input-label cursor-pointer inline-flex items-center gap-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 px-8 rounded-lg shadow-lg">
                            <i class="fas fa-upload"></i>
                            <span>Seleccionar archivo CSV</span>
                        </label>
                        <p id="file-name-display" class="mt-4 text-gray-400 text-sm h-5"></p>
                    </div>

                    <!-- Step 2: Preview & Download -->
                    <div id="result-step" class="text-center space-y-6">
                        <div id="status-message" class="text-xl font-light text-green-300 h-8 transition-opacity duration-300"></div>
                        
                        <button id="download-button" disabled class="btn-download w-full md:w-auto bg-gradient-to-r from-green-500 to-teal-500 hover:from-green-600 hover:to-teal-600 text-white font-bold py-4 px-10 rounded-lg shadow-xl text-lg disabled:bg-gray-500 disabled:from-gray-500">
                            <i class="fas fa-download mr-2"></i>
                            <span id="download-button-text">Descargar archivo .VCF</span>
                        </button>
                    </div>

                    <!-- Instructions -->
                    <div class="pt-6 border-t border-white/10 text-sm text-gray-400">
                        <h3 class="font-semibold text-gray-200 mb-2"><i class="fas fa-info-circle mr-2"></i>Instrucciones:</h3>
                        <ol class="list-decimal list-inside space-y-1">
                            <li>El archivo CSV debe tener una cabecera.</li>
                            <li>Asegúrate de tener columnas llamadas <strong>'number'</strong> y <strong>'name'</strong>.</li>
                            <li>El separador de columnas puede ser coma (,) o tabulación.</li>
                            <li>Los contactos sin un número válido serán ignorados.</li>
                            <li>Los contactos con número y nombre idénticos serán unificados.</li>
                        </ol>
                    </div>
                </div>
            </main>
        </div>
        <footer class="text-center mt-8 text-gray-500 text-sm">
            <p>Diseñado con <i class="fas fa-heart text-red-500"></i> para una gestión de contactos eficiente.</p>
        </footer>
    </div>

    <script>
        const fileInput = document.getElementById('csv-file-input');
        const fileNameDisplay = document.getElementById('file-name-display');
        const downloadButton = document.getElementById('download-button');
        const downloadButtonText = document.getElementById('download-button-text');
        const statusMessage = document.getElementById('status-message');
        
        let vcfData = '';
        let contactCount = 0;

        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            fileNameDisplay.textContent = `Archivo: ${file.name}`;
            statusMessage.textContent = 'Procesando...';
            statusMessage.classList.remove('text-red-400', 'text-green-300');
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    processCSV(e.target.result);
                } catch (error) {
                    console.error("Error processing file:", error);
                    statusMessage.textContent = 'Error al leer el archivo. Formato inválido.';
                    statusMessage.classList.add('text-red-400');
                    resetState();
                }
            };
            reader.onerror = () => {
                statusMessage.textContent = 'No se pudo leer el archivo.';
                statusMessage.classList.add('text-red-400');
                resetState();
            };
            reader.readAsText(file);
        });

        function processCSV(csvContent) {
            const lines = csvContent.replace(/\r/g, '').split('\n');
            if (lines.length < 2) {
                throw new Error("CSV has no data rows.");
            }

            const headerLine = lines[0];
            const delimiter = headerLine.includes('\t') ? '\t' : ',';
            const headers = headerLine.split(delimiter).map(h => h.trim().toLowerCase());

            const numberIndex = headers.indexOf('number');
            const nameIndex = headers.indexOf('name');
            
            if (numberIndex === -1 || nameIndex === -1) {
                throw new Error("CSV must contain 'number' and 'name' columns.");
            }

            const contacts = [];
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i];
                if (!line.trim()) continue;

                const values = line.split(delimiter);
                let number = values[numberIndex] ? values[numberIndex].trim() : '';
                let name = values[nameIndex] ? values[nameIndex].trim() : '';

                // Clean number: remove non-digits except leading '+'
                if (number) {
                    number = number.replace(/[^\d+]/g, '');
                }

                if (!number || !/^\+?\d{7,}$/.test(number)) {
                    continue; // Skip if number is invalid or too short
                }
                
                // If name is empty or just dots, use the number as name
                if (!name || /^\.+$/.test(name)) {
                    name = number;
                }
                
                contacts.push({ name, number });
            }

            // --- Deduplication logic starts here ---
            const totalParsed = contacts.length;
            const uniqueContacts = [];
            const seen = new Set();

            for (const contact of contacts) {
                const key = `${contact.number}|${contact.name}`; // Key based on both number and name
                if (!seen.has(key)) {
                    seen.add(key);
                    uniqueContacts.push(contact);
                }
            }

            const duplicatesRemoved = totalParsed - uniqueContacts.length;
            contactCount = uniqueContacts.length;
            // --- Deduplication logic ends here ---


            if (contactCount > 0) {
                vcfData = generateVCF(uniqueContacts); // Use the deduplicated list
                let message = `${contactCount} contactos listos para ser convertidos.`;
                if (duplicatesRemoved > 0) {
                    message = `${contactCount} contactos listos. Se eliminaron ${duplicatesRemoved} duplicados.`;
                }
                statusMessage.textContent = message;
                statusMessage.classList.add('text-green-300');
                downloadButton.disabled = false;
                downloadButtonText.textContent = `Descargar ${contactCount} Contactos`;
            } else {
                statusMessage.textContent = 'No se encontraron contactos válidos en el archivo.';
                statusMessage.classList.add('text-red-400');
                resetState();
            }
        }

        function generateVCF(contacts) {
            return contacts.map(contact => {
                return [
                    'BEGIN:VCARD',
                    'VERSION:3.0',
                    `FN:${contact.name}`,
                    `TEL;TYPE=CELL:${contact.number}`,
                    'END:VCARD'
                ].join('\n');
            }).join('\n');
        }
        
        function resetState() {
            downloadButton.disabled = true;
            vcfData = '';
            contactCount = 0;
            downloadButtonText.textContent = 'Descargar archivo .VCF';
        }

        downloadButton.addEventListener('click', () => {
            if (!vcfData || contactCount === 0) {
                return;
            }

            const blob = new Blob([vcfData], { type: 'text/vcard;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            a.href = url;
            a.download = `contactos_${new Date().toISOString().slice(0,10)}.vcf`;
            document.body.appendChild(a);
            a.click();
            
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            statusMessage.textContent = '¡Descarga completada!';
            setTimeout(() => {
                if (statusMessage.textContent === '¡Descarga completada!') {
                     statusMessage.textContent = `${contactCount} contactos listos para ser convertidos.`;
                }
            }, 3000);
        });

    </script>
</body>
</html>
